<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Centre Court - Championship Tennis</title>
    <link rel="preload" href="court.jpg" as="image">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;600;800&display=swap');
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#1a1a2e,#0f0f1e);height:100vh;overflow:hidden;touch-action:none;overscroll-behavior:none;position:fixed;width:100%}
        .screen{position:fixed;inset:0;display:none;flex-direction:column;z-index:100}
        .screen.active{display:flex}
        .loading-screen{background:#000;justify-content:center;align-items:center;z-index:10000;overflow:hidden}
        .hero-image{position:relative;width:64vw;height:57vh;margin-bottom:15px;display:flex;justify-content:center;align-items:center}
        .hero-player{position:absolute;width:100%;height:100%;opacity:0;animation:slideInPlayer 0.6s ease-out 0.8s forwards;image-rendering:pixelated;clip-path:inset(0 20% 0 0);object-fit:contain}
        .hero-ball{position:absolute;width:100%;height:100%;opacity:0;animation:slideInBall 1.4s ease-in-out forwards;image-rendering:pixelated;clip-path:inset(0 0 0 80%);object-fit:contain}
        @keyframes slideInPlayer{0%{opacity:0;transform:translateX(-100vw)}100%{opacity:1;transform:translateX(0)}}
        @keyframes slideInBall{0%{opacity:0;transform:translateX(100vw)}100%{opacity:1;transform:translateX(0)}}
        .loading-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;animation:fadeInContent 0.8s ease-out 1.4s forwards;opacity:0;margin-top:-70px}
        @keyframes fadeInContent{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
        .loading-logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(48px,12vw,72px);background:linear-gradient(135deg,#9b59b6,#bb86fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:6px;text-shadow:0 0 30px rgba(187,134,252,0.3)}
        .loading-subtitle{color:rgba(255,255,255,0.5);font-size:13px;letter-spacing:5px;text-transform:uppercase;margin-bottom:50px}
        .play-button{padding:18px 70px;background:#fff;border:none;border-radius:35px;color:#1a1a2e;font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.3);transition:transform 0.2s,box-shadow 0.2s}
        .play-button:hover{transform:scale(1.05);box-shadow:0 15px 40px rgba(0,0,0,0.4)}
        .main-menu{background:linear-gradient(180deg,#1a1a2e 0%,#0d0d1a 100%);justify-content:space-between;padding:15px;overflow-y:auto;touch-action:pan-y;-webkit-overflow-scrolling:touch}
        .game-logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(42px,11vw,64px);color:#ffd700;text-align:center;letter-spacing:4px;text-shadow:3px 3px 0 #000,0 0 20px rgba(255,215,0,0.5)}
        .tagline{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,215,0,0.6);text-align:center}
        .player-card{background:linear-gradient(180deg,#3a4a6a 0%,#2a3a5a 100%);border:3px solid;border-color:#6a8aba #2a3a5a #2a3a5a #6a8aba;border-radius:8px;padding:12px;margin:10px 0;box-shadow:3px 3px 0 rgba(0,0,0,0.4)}
        .player-level{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .level-badge{background:linear-gradient(180deg,#ffd700 0%,#cc9900 100%);padding:5px 12px;border:2px solid;border-color:#ffed4e #886600 #886600 #ffed4e;border-radius:4px;font-size:11px;font-weight:700;color:#000}
        .skill-progress{margin-bottom:15px}
        .skill-label{font-size:9px;color:rgba(255,215,0,0.8);margin-bottom:6px;text-align:center}
        .skill-bar{height:8px;background:rgba(0,0,0,0.3);border-radius:10px;overflow:hidden}
        .skill-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0%;transition:width 0.3s}
        .currency-display{display:flex;gap:15px}
        .currency-item{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.3);padding:6px 12px;border-radius:15px}
        .currency-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px}
        .coins{background:linear-gradient(135deg,#ffd700,#ffed4e)}
        .gems{background:linear-gradient(135deg,#e74c3c,#c0392b)}
        .currency-amount{font-family:'Bebas Neue',sans-serif;font-size:24px;color:#fff}
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        .stat-item{text-align:center;background:rgba(0,0,0,0.3);padding:8px 4px;border-radius:12px}
        .stat-label{font-size:8px;text-transform:uppercase;color:rgba(255,215,0,0.6)}
        .stat-value{font-family:'Bebas Neue',sans-serif;font-size:20px;background:linear-gradient(135deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .difficulty-section{margin:10px 0}
        .difficulty-title{text-align:center;color:rgba(255,215,0,0.8);font-size:11px;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px}
        .difficulty-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
        .difficulty-btn{padding:12px 8px;border:2px solid rgba(255,255,255,0.2);border-radius:12px;background:rgba(255,255,255,0.05);color:#fff;font-size:10px;font-weight:600;text-transform:uppercase;cursor:pointer}
        .difficulty-btn.selected{border-color:#ffd700;background:rgba(255,215,0,0.15)}
        .diff-rookie{border-color:#4caf50}
        .diff-pro{border-color:#ff9800}
        .diff-legend{border-color:#f44336}
        .difficulty-reward{display:block;font-size:8px;color:rgba(255,255,255,0.6);margin-top:3px}
        .menu-buttons{display:flex;flex-direction:column;gap:12px}
        .menu-btn{padding:14px 20px;background:linear-gradient(180deg,#4a5a7a 0%,#3a4a6a 50%,#2a3a5a 100%);border:3px solid;border-color:#6a8aba #2a3a5a #2a3a5a #6a8aba;border-radius:6px;color:#fff;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer;text-shadow:1px 1px 2px #000;box-shadow:3px 3px 0 rgba(0,0,0,0.4)}
        .menu-btn:active{transform:translate(2px,2px);box-shadow:1px 1px 0 rgba(0,0,0,0.4)}
        .menu-btn.primary{background:linear-gradient(180deg,#ffd700 0%,#cc9900 50%,#aa7700 100%);border-color:#ffed4e #886600 #886600 #ffed4e;color:#000;font-size:15px;padding:16px 24px;text-shadow:none}
        .video-intro{position:fixed;inset:0;background:#000;display:none;z-index:5000;justify-content:center;align-items:center;opacity:1;transition:opacity 0.5s ease}
        .video-intro.active{display:flex}
        .video-intro.fade-out{opacity:0}
        .skip-btn{position:absolute;bottom:30px;right:20px;padding:12px 24px;background:rgba(255,215,0,0.9);border:none;border-radius:8px;color:#1a1a2e;font-weight:700;font-size:14px;cursor:pointer;z-index:5001}
        #videoPlayer{width:100vw;height:100vh;object-fit:cover}
        .game-hud{position:fixed;top:0;left:0;right:0;padding:10px 15px;display:none;z-index:100;background:linear-gradient(to bottom,rgba(0,0,0,0.8),transparent)}
        .game-hud.active{display:block}
        .match-info{display:flex;justify-content:space-between;align-items:flex-start}
        .player-info{background:rgba(0,0,0,0.5);padding:10px 15px;border-radius:12px;border:1px solid rgba(255,215,0,0.3);text-align:center;min-width:80px}
        .player-name{font-size:9px;text-transform:uppercase;color:rgba(255,215,0,0.8)}
        .player-points{font-family:'Bebas Neue',sans-serif;font-size:32px;background:linear-gradient(135deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .player-games{font-size:9px;color:rgba(255,255,255,0.7);margin-top:2px}
        .player-sets{font-size:10px;color:#4caf50;font-weight:700;margin-top:2px}
        .match-center{display:flex;flex-direction:column;align-items:center;gap:4px}
        .match-timer{background:rgba(255,215,0,0.2);padding:6px 16px;border-radius:20px;color:#fff;font-size:13px;font-weight:700}
        .rally-counter{font-size:9px;color:rgba(255,255,255,0.7);text-transform:uppercase}
        .serve-indicator{font-size:9px;color:#4caf50;font-weight:700;text-transform:uppercase;padding:3px 8px;background:rgba(76,175,80,0.2);border-radius:10px}
        .serve-indicator.fault{color:#f44336;background:rgba(244,67,54,0.2)}
        .serve-speed{font-size:10px;color:#ffd700;font-weight:700;margin-top:2px}
        .tiebreak-indicator{font-size:8px;color:#ff9800;text-transform:uppercase;margin-top:2px}
        .game-court{position:fixed;inset:0;display:none;background:url('court.jpg') center/cover no-repeat;background-color:#000}
        .game-court.active{display:block}
        .game-court.shake{animation:screenShake 0.15s ease-in-out}
        @keyframes screenShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}}
        .court{position:absolute;top:12%;left:8%;right:8%;bottom:12%;background:transparent;border:none;overflow:hidden}
        .court-lines{position:absolute;inset:0;display:none}
        .line{position:absolute;background:#fff;opacity:0.95}
        .sideline-left{left:12%;top:0;bottom:0;width:3px}
        .sideline-right{right:12%;top:0;bottom:0;width:3px}
        .baseline-top{top:6%;left:0;right:0;height:3px}
        .baseline-bottom{bottom:6%;left:0;right:0;height:3px}
        .service-top{top:27%;left:12%;right:12%;height:2px}
        .service-bottom{bottom:27%;left:12%;right:12%;height:2px}
        .center-service{left:50%;top:27%;bottom:27%;width:2px}
        .net{top:50%;left:-2%;right:-2%;height:6px;background:linear-gradient(to bottom,rgba(255,255,255,0.9),rgba(100,100,100,0.9));z-index:20;transform:translateY(-50%)}
        /* Service box highlighting */
        .service-box{position:absolute;border:3px solid transparent;border-radius:8px;pointer-events:none;z-index:15;opacity:0;transition:opacity 0.3s}
        .service-box.deuce{top:27%;bottom:50%;left:50%;right:12%}
        .service-box.ad{top:27%;bottom:50%;left:12%;right:50%}
        .service-box.active{opacity:1;border-color:rgba(76,255,80,0.5);background:rgba(76,255,80,0.1);animation:serviceBoxPulse 1s ease-in-out infinite}
        @keyframes serviceBoxPulse{0%,100%{border-color:rgba(76,255,80,0.3)}50%{border-color:rgba(76,255,80,0.7)}}
        /* Net cord effect */
        .net-cord{position:absolute;top:50%;left:-2%;right:-2%;height:6px;z-index:21;transform:translateY(-50%);pointer-events:none;opacity:0}
        .net-cord.active{animation:netCordFlash 0.4s ease-out}
        @keyframes netCordFlash{0%{opacity:1;box-shadow:0 0 20px rgba(255,215,0,0.8),0 0 40px rgba(255,215,0,0.5)}100%{opacity:0;box-shadow:none}}
        .ball{position:absolute;width:14px;height:14px;background:radial-gradient(circle at 30% 30%,#fcf836,#c9d11a);border-radius:50%;transform:translate(-50%,-50%);z-index:40;display:none;box-shadow:0 2px 4px rgba(0,0,0,0.4)}
        .ball.active{display:block}
        .ball.glowing{box-shadow:0 0 30px rgba(76,255,80,1),0 0 50px rgba(76,255,80,0.5);animation:ballGlow 0.4s ease-in-out infinite}
        .ball.toss{animation:ballToss 0.6s ease-out}
        @keyframes ballToss{0%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-150%) scale(1.2)}100%{transform:translate(-50%,-50%) scale(1)}}
        @keyframes ballGlow{0%,100%{transform:translate(-50%,-50%) scale(1.3)}50%{transform:translate(-50%,-50%) scale(1.6)}}
        /* Ball trail effect */
        .ball-trail{position:absolute;width:10px;height:10px;background:rgba(252,248,54,0.4);border-radius:50%;transform:translate(-50%,-50%);z-index:38;pointer-events:none;opacity:0;transition:opacity 0.1s}
        .ball-shadow{position:absolute;width:20px;height:8px;background:radial-gradient(ellipse at center,rgba(0,0,0,0.4),transparent 70%);border-radius:50%;transform:translate(-50%,0);z-index:25;display:none}
        .ball-shadow.active{display:block}
        .opponent{position:absolute;top:5%;left:50%;transform:translateX(-50%);width:80px;height:96px;display:flex;align-items:center;justify-content:center;z-index:30;transition:left 0.2s ease-out}
        .opponent.hitting{animation:opponentHit 0.3s ease}
        @keyframes opponentHit{50%{transform:translateX(-50%) scale(1.2) rotate(-5deg)}}
        .player-paddle{position:absolute;bottom:5%;width:86px;height:104px;display:flex;align-items:center;justify-content:center;transform:translateX(-50%);transition:left 0.1s ease-out;z-index:35}
        .player-paddle.can-hit{filter:drop-shadow(0 0 20px rgba(76,255,80,0.8));animation:paddleReady 0.4s ease-in-out infinite}
        .player-paddle.serving{filter:drop-shadow(0 0 25px rgba(255,215,0,0.8))}
        @keyframes paddleReady{0%,100%{transform:translateX(-50%) scale(1.05)}50%{transform:translateX(-50%) scale(1)}}
        .player-sprite{position:relative;width:80px;height:96px;overflow:hidden;image-rendering:pixelated;transform:scale(1);transition:transform 0.2s ease}
        .player-sprite.flipped{transform:scaleX(-1)}
        .player-paddle .player-sprite.near{transform:scale(1.13)!important}
        .player-paddle .player-sprite.near.flipped{transform:scale(-1.13,1.13)!important}
        .sprite-inner{width:80px;height:96px;background-size:640px 96px;background-repeat:no-repeat;background-position:0 0}
        .sprite-inner.playing-8{animation:playSprite8 0.5s steps(7) 1}
        .sprite-inner.playing-7{animation:playSprite7 0.5s steps(6) 1}
        .sprite-inner.playing-5{animation:playSprite5 0.5s steps(4) 1}
        .sprite-inner.playing-4{animation:playSprite4 0.4s steps(3) 1}
        .sprite-inner.cycling{animation:playSprite8 0.8s steps(7) infinite}
        @keyframes playSprite8{0%{background-position:0 0}100%{background-position:-560px 0}}
        @keyframes playSprite7{0%{background-position:0 0}100%{background-position:-360px 0}}
        @keyframes playSprite5{0%{background-position:0% var(--sprite-y)}100%{background-position:100% var(--sprite-y)}}
        @keyframes playSprite4{0%{background-position:0% var(--sprite-y)}100%{background-position:100% var(--sprite-y)}}
        .hit-zone{position:absolute;bottom:8%;left:8%;right:8%;top:52%;border:3px dashed rgba(255,215,0,0.2);border-radius:20px;pointer-events:none;z-index:5;display:none}
        .hit-zone.active{border-color:rgba(76,255,80,0.4);background:rgba(76,255,80,0.05)}
        /* Serve power meter */
        .serve-power{position:absolute;bottom:20%;left:50%;transform:translateX(-50%);width:60%;max-width:200px;display:none;flex-direction:column;align-items:center;gap:8px;z-index:100}
        .serve-power.active{display:flex}
        .serve-power-label{font-size:11px;color:#fff;text-transform:uppercase;letter-spacing:2px;text-shadow:0 2px 4px rgba(0,0,0,0.5)}
        .serve-power-bar{width:100%;height:20px;background:rgba(0,0,0,0.6);border:2px solid rgba(255,215,0,0.5);border-radius:10px;overflow:hidden}
        .serve-power-fill{height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#ffd700 50%,#f44336);transition:width 0.05s}
        .serve-power-zones{display:flex;justify-content:space-between;width:100%;font-size:8px;color:rgba(255,255,255,0.6);padding:0 2px}
        /* Serve aim indicator */
        .serve-aim{position:absolute;width:30px;height:30px;border:3px solid #ffd700;border-radius:50%;transform:translate(-50%,-50%);z-index:45;display:none;pointer-events:none;box-shadow:0 0 15px rgba(255,215,0,0.5)}
        .serve-aim.active{display:block;animation:aimPulse 0.8s ease-in-out infinite}
        .serve-aim-dot{position:absolute;top:50%;left:50%;width:6px;height:6px;background:#ffd700;border-radius:50%;transform:translate(-50%,-50%)}
        @keyframes aimPulse{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:1}50%{transform:translate(-50%,-50%) scale(1.3);opacity:0.8}}
        /* Serve target line */
        .serve-target-line{position:absolute;width:2px;background:linear-gradient(to top,rgba(255,215,0,0.6),transparent);z-index:44;display:none;pointer-events:none;transform-origin:bottom center}
        .serve-target-line.active{display:block}
        .power-bar{position:absolute;bottom:2%;left:20%;right:20%;height:12px;background:rgba(0,0,0,0.5);border:2px solid rgba(255,215,0,0.5);border-radius:6px;overflow:hidden;display:none}
        .power-fill{height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#ffd700,#f44336);transition:width 0.15s}
        .hit-effect{position:absolute;width:120px;height:120px;border:4px solid #ffd700;border-radius:50%;opacity:0;pointer-events:none;transform:translate(-50%,-50%) scale(0.5);z-index:200;display:none}
        .hit-effect.active{animation:hitRipple 0.6s ease-out}
        @keyframes hitRipple{0%{opacity:1;transform:translate(-50%,-50%) scale(0.5)}100%{opacity:0;transform:translate(-50%,-50%) scale(2.5)}}
        /* Gem improvements */
        .gem-drop{position:absolute;width:45px;height:45px;font-size:36px;display:none;transform:translate(-50%,-50%);z-index:150;cursor:pointer;filter:drop-shadow(0 0 10px rgba(231,76,60,0.8))}
        .gem-drop.active{display:block;animation:gemFloat 1.5s ease-in-out infinite}
        .gem-drop.urgent{animation:gemUrgent 0.3s ease-in-out infinite}
        @keyframes gemFloat{0%,100%{transform:translate(-50%,-50%) scale(1) rotate(0deg)}50%{transform:translate(-50%,-60%) scale(1.15) rotate(10deg)}}
        @keyframes gemUrgent{0%,100%{transform:translate(-50%,-50%) scale(1.1);filter:drop-shadow(0 0 20px rgba(255,0,0,0.9))}50%{transform:translate(-50%,-50%) scale(0.9);filter:drop-shadow(0 0 10px rgba(255,0,0,0.5))}}
        /* Gem collect particles */
        .gem-particle{position:absolute;width:8px;height:8px;background:linear-gradient(135deg,#e74c3c,#ff6b6b);border-radius:50%;pointer-events:none;z-index:160}
        @keyframes gemBurst{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
        .gem-timer{position:absolute;bottom:-15px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.8);white-space:nowrap}
        .gem-multiplier{position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#ffd700,#ffed4e);color:#1a1a2e;font-size:9px;font-weight:700;padding:2px 5px;border-radius:8px}
        .combo-text{position:absolute;font-family:'Bebas Neue',sans-serif;font-size:42px;background:linear-gradient(135deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;pointer-events:none;z-index:500}
        @keyframes comboFloat{0%{opacity:1;transform:translate(-50%,-50%) scale(0)}50%{opacity:1;transform:translate(-50%,-80px) scale(1.4)}100%{opacity:0;transform:translate(-50%,-120px) scale(1)}}
        /* Streak indicator */
        .streak-display{position:fixed;bottom:15%;right:10px;background:rgba(0,0,0,0.7);border:2px solid rgba(255,215,0,0.4);border-radius:12px;padding:8px 12px;display:none;z-index:100}
        .streak-display.active{display:block}
        .streak-label{font-size:8px;color:rgba(255,215,0,0.8);text-transform:uppercase}
        .streak-value{font-family:'Bebas Neue',sans-serif;font-size:28px;color:#ffd700}
        .streak-bonus{font-size:9px;color:#4caf50}
        .swipe-hint{position:absolute;bottom:35%;left:50%;transform:translateX(-50%);padding:10px 20px;background:rgba(76,255,80,0.7);border-radius:10px;color:#fff;font-size:13px;font-weight:700;text-transform:uppercase;opacity:0;pointer-events:none;display:none;text-align:center}
        .swipe-hint.active{opacity:1;animation:hintPulse 0.8s ease-in-out infinite}
        .swipe-hint.serve{background:rgba(255,215,0,0.8);color:#1a1a2e}
        @keyframes hintPulse{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.1)}}
        /* Court change overlay */
        .court-change{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:500;flex-direction:column;gap:15px}
        .court-change.active{display:flex;animation:fadeInChange 0.5s ease}
        @keyframes fadeInChange{from{opacity:0}to{opacity:1}}
        .court-change-text{font-family:'Bebas Neue',sans-serif;font-size:48px;color:#ffd700;text-align:center}
        .court-change-sub{font-size:14px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:3px}
        /* Out/Fault callout */
        .call-overlay{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-family:'Bebas Neue',sans-serif;font-size:64px;color:#f44336;text-shadow:0 4px 20px rgba(0,0,0,0.8);opacity:0;pointer-events:none;z-index:200}
        .call-overlay.active{animation:callPop 0.8s ease-out forwards}
        .call-overlay.in{color:#4caf50}
        @keyframes callPop{0%{opacity:0;transform:translate(-50%,-50%) scale(0.5)}30%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}100%{opacity:0;transform:translate(-50%,-50%) scale(1)}}
        .match-results{background:#000;justify-content:center;align-items:center;padding:20px;z-index:2000}
        .results-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(48px,15vw,64px);margin-bottom:10px}
        .victory{background:linear-gradient(135deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .defeat{background:linear-gradient(135deg,#f44336,#e91e63);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .final-score{font-family:'Bebas Neue',sans-serif;font-size:42px;color:#fff;margin-bottom:25px}
        .rewards-container{background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,237,78,0.05));border:2px solid rgba(255,215,0,0.3);border-radius:20px;padding:20px;margin-bottom:25px;width:100%;max-width:320px}
        .rewards-title{font-size:13px;text-transform:uppercase;letter-spacing:3px;color:rgba(255,215,0,0.8);margin-bottom:15px;text-align:center}
        .reward-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,215,0,0.1)}
        .reward-item:last-child{border-bottom:none}
        .reward-label{font-size:13px;color:rgba(255,255,255,0.8);text-transform:uppercase}
        .reward-value{font-family:'Bebas Neue',sans-serif;font-size:28px;background:linear-gradient(135deg,#4caf50,#8bc34a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .continue-btn{padding:18px 50px;background:linear-gradient(135deg,#ffd700,#ffed4e);border:none;border-radius:25px;color:#1a1a2e;font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;cursor:pointer}
        .progress-toast{position:fixed;top:-80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#ffd700,#ffed4e);padding:12px 25px;border-radius:25px;color:#1a1a2e;font-weight:700;z-index:3000;transition:top 0.4s ease}
        .progress-toast.show{top:40px}
        .shop-screen{background:linear-gradient(180deg,#1a1a2e 0%,#0d0d1a 100%);padding:12px;overflow-y:auto;z-index:1100;touch-action:pan-y;-webkit-overflow-scrolling:touch}
        /* ARCADE STYLE CHARACTER SELECT */
        .char-select{background:linear-gradient(180deg,#1a1a2e 0%,#0d0d1a 100%);padding:10px 10px 80px;overflow-y:auto;z-index:1100;flex-direction:column;position:relative;touch-action:pan-y;-webkit-overflow-scrolling:touch}
        .char-select::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.1) 2px,rgba(0,0,0,0.1) 4px);pointer-events:none;z-index:9999}
        .char-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;overflow-y:scroll;touch-action:pan-y;-webkit-overflow-scrolling:touch;flex:1;padding:10px;background:linear-gradient(135deg,#2a3a5a 0%,#1a2a4a 100%);border:3px solid #4a6a9a;border-radius:8px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.5),0 4px 8px rgba(0,0,0,0.3);max-height:calc(100vh - 280px)}
        .char-select-btn{position:fixed;bottom:15px;left:15px;right:15px;z-index:1101;background:linear-gradient(180deg,#ffd700 0%,#cc9900 50%,#aa7700 100%)!important;border:3px solid!important;border-color:#ffed4e #886600 #886600 #ffed4e!important;color:#000!important;text-shadow:none!important;box-shadow:3px 3px 0 #0a1a2a!important;font-size:16px!important;letter-spacing:3px!important}
        .char-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:8px 12px;background:linear-gradient(180deg,#4a6a9a 0%,#3a5a8a 50%,#2a4a7a 100%);border:2px solid #6a8aba;border-radius:6px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.2),0 2px 4px rgba(0,0,0,0.3)}
        .char-title{font-family:'Bebas Neue',sans-serif;font-size:22px;color:#fff;text-shadow:2px 2px 0 #000,0 0 10px rgba(100,200,255,0.5);letter-spacing:3px}
        .char-card{background:linear-gradient(180deg,#3a4a6a 0%,#2a3a5a 50%,#1a2a4a 100%);border:3px solid;border-color:#6a8aba #2a3a5a #2a3a5a #6a8aba;border-radius:4px;padding:6px;text-align:center;cursor:pointer;transition:all 0.15s;box-shadow:2px 2px 0 #0a1a2a}
        .char-card:active{transform:translate(1px,1px);box-shadow:1px 1px 0 #0a1a2a}
        .char-card.selected{border-color:#ffd700 #aa8800 #aa8800 #ffd700;background:linear-gradient(180deg,#4a5a7a 0%,#3a4a6a 50%,#2a3a5a 100%);box-shadow:2px 2px 0 #0a1a2a,0 0 15px rgba(255,215,0,0.4)}
        .char-card.locked{opacity:0.6;filter:grayscale(0.5) brightness(0.7)}
        .char-preview{width:56px;height:68px;margin:0 auto 4px;background-size:448px 68px;background-repeat:no-repeat;background-position:0 0;image-rendering:pixelated;border:2px solid #1a2a4a;background-color:#0a0a1a}
        .char-name{font-size:9px;color:#8ac;font-weight:700;text-transform:uppercase;text-shadow:1px 1px 0 #000;letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .char-stats{font-size:8px;color:#6a8aba;margin-top:2px;font-family:monospace}
        .char-stat-bars{margin-top:4px}
        .stat-bar-row{display:flex;align-items:center;gap:2px;margin:2px 0}
        .stat-lbl{font-size:7px;color:#6a8aba;width:8px;text-align:center}
        .stat-bar{flex:1;height:4px;background:#1a2a4a;border-radius:2px;overflow:hidden}
        .stat-fill{height:100%;border-radius:2px}
        .stat-fill.pwr{background:linear-gradient(90deg,#ff6b6b,#ff4757)}
        .stat-fill.spd{background:linear-gradient(90deg,#4ecdc4,#26de81)}
        .stat-fill.ctl{background:linear-gradient(90deg,#45aaf2,#2d98da)}
        .char-lock{font-size:16px;margin-bottom:3px;filter:drop-shadow(0 0 3px #000)}
        .char-detail{background:linear-gradient(180deg,#3a4a6a 0%,#2a3a5a 100%);border:3px solid;border-color:#6a8aba #2a3a5a #2a3a5a #6a8aba;border-radius:6px;padding:12px;margin-bottom:10px;box-shadow:3px 3px 0 #0a1a2a}
        .char-detail-preview{width:72px;height:86px;margin:0 auto 8px;background-size:576px 86px;background-repeat:no-repeat;image-rendering:pixelated;border:2px solid #1a2a4a;background-color:#0a0a1a}
        .char-detail-preview.animating{animation:charPreview 1.2s steps(7) infinite}
        @keyframes charPreview{0%{background-position:0 0}100%{background-position:-504px 0}}
        .char-detail-name{font-family:'Bebas Neue',sans-serif;font-size:20px;color:#ffd700;text-align:center;text-shadow:2px 2px 0 #000;letter-spacing:2px}
        .char-detail-stats{display:flex;justify-content:center;gap:15px;margin-top:8px}
        .char-stat{text-align:center}
        .char-stat-label{font-size:8px;color:#6a8aba;text-transform:uppercase;letter-spacing:1px}
        .char-stat-value{font-family:'Bebas Neue',sans-serif;font-size:18px;color:#8cf;text-shadow:1px 1px 0 #000}
        .shop-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:8px 12px;background:linear-gradient(180deg,#4a6a9a 0%,#3a5a8a 50%,#2a4a7a 100%);border:2px solid #6a8aba;border-radius:6px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.2),0 2px 4px rgba(0,0,0,0.3)}
        .shop-title{font-family:'Bebas Neue',sans-serif;font-size:22px;color:#fff;text-shadow:2px 2px 0 #000,0 0 10px rgba(100,200,255,0.5);letter-spacing:3px}
        .back-btn{padding:8px 16px;background:linear-gradient(180deg,#5a6a8a 0%,#4a5a7a 50%,#3a4a6a 100%);border:2px solid;border-color:#8a9aba #3a4a6a #3a4a6a #8a9aba;border-radius:4px;color:#fff;font-size:10px;font-weight:700;text-transform:uppercase;cursor:pointer;text-shadow:1px 1px 0 #000;box-shadow:2px 2px 0 #0a1a2a}
        .back-btn:active{transform:translate(1px,1px);box-shadow:1px 1px 0 #0a1a2a}
        .shop-tabs{display:flex;gap:4px;margin-bottom:12px;background:linear-gradient(180deg,#2a3a5a 0%,#1a2a4a 100%);padding:6px;border:2px solid #4a6a9a;border-radius:6px;flex-wrap:wrap}
        .shop-tab{flex:1;padding:8px 6px;background:linear-gradient(180deg,#3a4a6a 0%,#2a3a5a 100%);border:2px solid;border-color:#5a7a9a #1a2a4a #1a2a4a #5a7a9a;border-radius:4px;color:#8ac;font-size:9px;font-weight:700;text-transform:uppercase;cursor:pointer;min-width:55px;text-shadow:1px 1px 0 #000}
        .shop-tab.active{background:linear-gradient(180deg,#ffd700 0%,#cc9900 100%);border-color:#ffed4e #886600 #886600 #ffed4e;color:#000;text-shadow:none}
        .shop-items{display:grid;gap:8px;padding-bottom:20px;overflow-y:auto;max-height:calc(100vh - 180px);touch-action:pan-y;-webkit-overflow-scrolling:touch}
        .shop-item{background:linear-gradient(180deg,#3a4a6a 0%,#2a3a5a 100%);border:2px solid;border-color:#5a7a9a #1a2a4a #1a2a4a #5a7a9a;border-radius:6px;padding:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:2px 2px 0 rgba(0,0,0,0.3)}
        .shop-item.owned{border-color:#4caf50 #2a6a2a #2a6a2a #4caf50}
        .item-info{flex:1;max-width:55%}
        .item-name{font-size:12px;font-weight:700;color:#ffd700;margin-bottom:2px;text-shadow:1px 1px 0 #000}
        .item-desc{font-size:9px;color:#8ac;margin-bottom:4px}
        .item-stats{display:flex;gap:6px;flex-wrap:wrap}
        .item-stat{font-size:8px;color:#4caf50;font-weight:600;background:rgba(76,175,80,0.2);padding:2px 5px;border-radius:4px}
        .item-purchase{display:flex;flex-direction:column;align-items:center;gap:6px}
        .price-tag{display:flex;align-items:center;gap:5px;padding:5px 8px;background:rgba(0,0,0,0.4);border-radius:6px;font-family:'Bebas Neue',sans-serif;font-size:18px;color:#fff}
        .buy-btn{padding:7px 14px;background:linear-gradient(135deg,#4caf50,#8bc34a);border:none;border-radius:6px;color:#fff;font-size:9px;font-weight:700;text-transform:uppercase;cursor:pointer}
        .buy-btn:disabled{background:#555;opacity:0.5}
        .equip-btn{padding:7px 14px;background:linear-gradient(135deg,#2196f3,#03a9f4);border:none;border-radius:6px;color:#fff;font-size:9px;font-weight:700;text-transform:uppercase;cursor:pointer}
        .equipped-badge{padding:7px 14px;background:linear-gradient(135deg,#ffd700,#ffed4e);border:none;border-radius:6px;color:#1a1a2e;font-size:9px;font-weight:700;text-transform:uppercase}
        .tutorial-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);display:none;justify-content:center;align-items:center;z-index:3000;padding:20px}
        .tutorial-overlay.active{display:flex}
        .tutorial-content{background:#000;border:2px solid rgba(187,134,252,0.4);border-radius:20px;padding:25px;max-width:360px;text-align:center}
        .tutorial-title{font-family:'Bebas Neue',sans-serif;font-size:32px;background:linear-gradient(135deg,#ffd700,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:15px}
        .tutorial-text{color:rgba(255,255,255,0.8);font-size:13px;line-height:1.5;margin-bottom:20px}
        .tutorial-btn{padding:14px 35px;background:linear-gradient(135deg,#4caf50,#8bc34a);border:none;border-radius:20px;color:#fff;font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer}
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <div class="screen loading-screen active" id="loadingScreen">
        <div style="display:flex;flex-direction:column;align-items:center;margin-top:-60px;">
            <div class="hero-image">
                <img src="hero_player.jpg" alt="Tennis Player" class="hero-player">
                <img src="hero_player.jpg" alt="Tennis Ball" class="hero-ball">
            </div>
            <div class="loading-content">
                <div class="loading-logo">CENTRE COURT</div>
                <div class="loading-subtitle">Championship Edition</div>
                <button class="play-button" onclick="startGame()">PLAY NOW</button>
            </div>
        </div>
    </div>
    <div class="screen main-menu" id="mainMenu">
        <div><h1 class="game-logo">CENTRE COURT</h1><p class="tagline">Championship Edition</p></div>
        <div class="player-card">
            <div class="player-level">
                <div class="level-badge">NTRP <span id="playerNTRP">2.5</span></div>
                <div class="currency-display">
                    <div class="currency-item"><div class="currency-icon coins">üí∞</div><div class="currency-amount" id="coinAmount">500</div></div>
                    <div class="currency-item"><div class="currency-icon gems">üíé</div><div class="currency-amount" id="gemAmount">20</div></div>
                </div>
            </div>
            <div class="skill-progress">
                <div class="skill-label">Skill Points: <span id="skillPoints">0</span> / <span id="skillNeeded">300</span></div>
                <div class="skill-bar"><div class="skill-fill" id="skillFill"></div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-label">Power</div><div class="stat-value" id="statPower">10</div></div>
                <div class="stat-item"><div class="stat-label">Speed</div><div class="stat-value" id="statSpeed">10</div></div>
                <div class="stat-item"><div class="stat-label">Control</div><div class="stat-value" id="statControl">10</div></div>
                <div class="stat-item"><div class="stat-label">Serve</div><div class="stat-value" id="statServe">10</div></div>
            </div>
        </div>
        <div class="difficulty-section">
            <div class="difficulty-title">Select Difficulty</div>
            <div class="difficulty-buttons">
                <button class="difficulty-btn diff-rookie selected" onclick="selectDifficulty('rookie')">Rookie<span class="difficulty-reward">1x Rewards</span></button>
                <button class="difficulty-btn diff-pro" onclick="selectDifficulty('pro')">Pro<span class="difficulty-reward">2x Rewards</span></button>
                <button class="difficulty-btn diff-legend" onclick="selectDifficulty('legend')">Legend<span class="difficulty-reward">3x Rewards</span></button>
            </div>
        </div>
        <div class="difficulty-section">
            <div class="difficulty-title">Match Length</div>
            <div class="difficulty-buttons">
                <button class="difficulty-btn selected" onclick="selectMatchType('quick')" id="matchQuick">Quick<span class="difficulty-reward">First to 3</span></button>
                <button class="difficulty-btn" onclick="selectMatchType('standard')" id="matchStandard">Standard<span class="difficulty-reward">First to 6</span></button>
                <button class="difficulty-btn" onclick="selectMatchType('timed')" id="matchTimed">Timed<span class="difficulty-reward">Best of Time</span></button>
            </div>
        </div>
        <div class="menu-buttons">
            <button class="menu-btn primary" onclick="startMatch()">PLAY MATCH</button>
            <button class="menu-btn" onclick="showCharSelect()">SELECT PLAYER</button>
            <button class="menu-btn" onclick="showShop()">PRO SHOP</button>
            <button class="menu-btn" onclick="showTutorial()">HOW TO PLAY</button>
        </div>
    </div>
    <div class="screen shop-screen" id="shopScreen">
        <div class="shop-header"><h2 class="shop-title">PRO SHOP</h2><button class="back-btn" onclick="closeShop()">BACK</button></div>
        <div class="shop-tabs">
            <button class="shop-tab active" onclick="switchTab('training',this)">Training</button>
            <button class="shop-tab" onclick="switchTab('serve',this)">Serve</button>
            <button class="shop-tab" onclick="switchTab('rackets',this)">Rackets</button>
            <button class="shop-tab" onclick="switchTab('shoes',this)">Shoes</button>
            <button class="shop-tab" onclick="switchTab('special',this)">Special</button>
        </div>
        <div class="shop-items" id="shopItems"></div>
    </div>
    <div class="screen char-select" id="charSelect">
        <div class="char-header"><h2 class="char-title">SELECT PLAYER</h2><button class="back-btn" onclick="closeCharSelect()">BACK</button></div>
        <div class="char-detail" id="charDetail">
            <div class="char-detail-preview animating" id="charDetailPreview"></div>
            <div class="char-detail-name" id="charDetailName">ROGER FEDORA</div>
            <div class="char-detail-stats">
                <div class="char-stat"><div class="char-stat-label">Power</div><div class="char-stat-value" id="charPower">50</div></div>
                <div class="char-stat"><div class="char-stat-label">Speed</div><div class="char-stat-value" id="charSpeed">50</div></div>
                <div class="char-stat"><div class="char-stat-label">Control</div><div class="char-stat-value" id="charControl">50</div></div>
            </div>
        </div>
        <div class="char-grid" id="charGrid"></div>
        <button class="menu-btn primary char-select-btn" onclick="confirmCharacter()">SELECT</button>
    </div>
    <div class="video-intro" id="videoIntro">
        <div id="videoPlayer"></div>
        <button class="skip-btn" onclick="transitionToCourt()">SKIP ‚ñ∂</button>
    </div>
    <div class="game-hud" id="gameHUD">
        <div class="match-info">
            <div class="player-info">
                <div class="player-name">YOU</div>
                <div class="player-points" id="playerPoints">0</div>
                <div class="player-games">Games: <span id="playerGames">0</span></div>
                <div class="player-sets" id="playerSets"></div>
            </div>
            <div class="match-center">
                <div class="match-timer" id="matchTimer">2:00</div>
                <div class="rally-counter">Rally: <span id="rallyCount">0</span></div>
                <div class="serve-indicator" id="serveIndicator">1ST SERVE</div>
                <div class="serve-speed" id="serveSpeed"></div>
                <div class="tiebreak-indicator" id="tiebreakIndicator"></div>
            </div>
            <div class="player-info">
                <div class="player-name">CPU</div>
                <div class="player-points" id="opponentPoints">0</div>
                <div class="player-games">Games: <span id="opponentGames">0</span></div>
                <div class="player-sets" id="opponentSets"></div>
            </div>
        </div>
    </div>
    <div class="game-court" id="gameCourt">
        <div class="court">
            <div class="court-lines">
                <div class="line sideline-left"></div><div class="line sideline-right"></div>
                <div class="line baseline-top"></div><div class="line baseline-bottom"></div>
                <div class="line service-top"></div><div class="line service-bottom"></div>
                <div class="line center-service"></div><div class="line net"></div>
                <div class="net-cord" id="netCord"></div>
            </div>
            <!-- Service boxes -->
            <div class="service-box deuce" id="serviceBoxDeuce"></div>
            <div class="service-box ad" id="serviceBoxAd"></div>
            <div class="hit-zone" id="hitZone"></div>
            <div class="opponent" id="opponent">
                <div class="player-sprite opponent-sprite">
                    <div class="sprite-inner" id="opponentSprite"></div>
                </div>
            </div>
            <div class="player-paddle" id="playerPaddle">
                <div class="player-sprite player-sprite-active near">
                    <div class="sprite-inner" id="playerSprite"></div>
                </div>
            </div>
            <div class="ball-shadow" id="ballShadow"></div>
            <div class="ball" id="ball"></div>
            <!-- Serve aim indicator -->
            <div class="serve-aim" id="serveAim"><div class="serve-aim-dot"></div></div>
            <div class="serve-target-line" id="serveTargetLine"></div>
            <div class="swipe-hint" id="swipeHint">SWIPE UP!</div>
            <!-- Serve power meter -->
            <div class="serve-power" id="servePower">
                <div class="serve-power-label">PULL DOWN FOR POWER</div>
                <div class="serve-power-bar"><div class="serve-power-fill" id="servePowerFill"></div></div>
                <div class="serve-power-zones"><span>SOFT</span><span>MEDIUM</span><span>POWER</span></div>
            </div>
            <div class="power-bar"><div class="power-fill" id="powerFill"></div></div>
            <div class="hit-effect" id="hitEffect"></div>
            <div class="gem-drop" id="gemDrop">üíé<div class="gem-timer" id="gemTimer"></div><div class="gem-multiplier" id="gemMultiplier">x1</div></div>
            <div class="call-overlay" id="callOverlay">OUT</div>
        </div>
    </div>
    <!-- Court change overlay -->
    <div class="court-change" id="courtChange">
        <div class="court-change-text" id="courtChangeText">CHANGEOVER</div>
        <div class="court-change-sub" id="courtChangeSub">Switching sides</div>
    </div>
    <!-- Streak display -->
    <div class="streak-display" id="streakDisplay">
        <div class="streak-label">STREAK</div>
        <div class="streak-value" id="streakValue">0</div>
        <div class="streak-bonus" id="streakBonus">+0% gems</div>
    </div>
    <div class="screen match-results" id="matchResults">
        <h2 class="results-title" id="resultsTitle">VICTORY</h2>
        <div class="final-score" id="finalScore">7 - 3</div>
        <div class="rewards-container">
            <div class="rewards-title">Match Rewards</div>
            <div class="reward-item"><span class="reward-label">Coins</span><span class="reward-value" id="coinsEarned">+50</span></div>
            <div class="reward-item"><span class="reward-label">Skill Points</span><span class="reward-value" id="skillGained">+100</span></div>
            <div class="reward-item"><span class="reward-label">Gems</span><span class="reward-value" id="gemsEarned">+0</span></div>
        </div>
        <div class="rewards-container" style="margin-top:-10px">
            <div class="rewards-title">Match Statistics</div>
            <div class="reward-item"><span class="reward-label">Aces</span><span class="reward-value" id="acesCount">0</span></div>
            <div class="reward-item"><span class="reward-label">Winners</span><span class="reward-value" id="winnersCount">0</span></div>
            <div class="reward-item"><span class="reward-label">Longest Rally</span><span class="reward-value" id="longestRally">0</span></div>
            <div class="reward-item"><span class="reward-label">Avg Rally</span><span class="reward-value" id="avgRally">0</span></div>
        </div>
        <button class="continue-btn" onclick="returnToMenu()">CONTINUE</button>
    </div>
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-content">
            <h2 class="tutorial-title">HOW TO PLAY</h2>
            <p class="tutorial-text">
                <strong>üéæ SERVING:</strong><br>
                When it's your serve, PULL DOWN to charge power, then RELEASE and swipe toward the service box!<br><br>
                <strong>‚ö° RETURNING:</strong><br>
                Watch for the GREEN GLOW - swipe up to hit!<br><br>
                <strong>üìç COURT:</strong><br>
                ‚Ä¢ Serve to deuce court (right) on even points<br>
                ‚Ä¢ Serve to ad court (left) on odd points<br>
                ‚Ä¢ Double fault = point lost!<br><br>
                <strong>üíé GEMS:</strong><br>
                Collect gems before they disappear! Build streaks for bonus gems!
            </p>
            <button class="tutorial-btn" onclick="closeTutorial()">GOT IT!</button>
        </div>
    </div>
    <div class="progress-toast" id="progressToast"></div>
<script>
const G={coins:500,gems:20,level:1,xp:0,ntrp:2.5,skillPoints:0,stats:{power:10,speed:10,control:10,serve:10},equipment:{racket:null,shoes:null,special:null,serveGear:null},owned:[],difficulty:'rookie',matchType:'quick',trainingCompleted:[]};

// Enhanced shop with serve equipment
const SHOP={
    rackets:[
        {id:'r1',name:'Starter Racket',desc:'Basic frame for beginners',stats:{power:5,control:5},price:100,currency:'coins'},
        {id:'r2',name:'Power Driver',desc:'Heavy head for devastating shots',stats:{power:20,control:5},price:500,currency:'coins'},
        {id:'r3',name:'Precision Pro',desc:'Perfect balance for control',stats:{power:10,control:25,speed:5},price:750,currency:'coins'},
        {id:'r4',name:'Champions Blade',desc:'Used by touring pros',stats:{power:25,control:25,speed:10},price:100,currency:'gems'},
        {id:'r5',name:'Graphite Pro',desc:'Lightweight power frame',stats:{power:15,speed:8,control:15},price:1200,currency:'coins'},
        {id:'r6',name:'Legend Series',desc:'Tournament champion gear',stats:{power:30,speed:5,control:30},price:200,currency:'gems'}
    ],
    shoes:[
        {id:'s1',name:'Court Runners',desc:'Standard court shoes',stats:{speed:10,control:5},price:150,currency:'coins'},
        {id:'s2',name:'Lightning Sprints',desc:'Ultra-light for speed',stats:{speed:30,control:10},price:600,currency:'coins'},
        {id:'s3',name:'Pro Tour Elite',desc:'Professional grade comfort',stats:{power:5,speed:20,control:15},price:1000,currency:'coins'},
        {id:'s4',name:'Rocket Boosters',desc:'Experimental tech shoes',stats:{power:10,speed:40,control:20},price:75,currency:'gems'},
        {id:'s5',name:'Clay Masters',desc:'Grip on any surface',stats:{speed:25,control:20},price:1500,currency:'coins'},
        {id:'s6',name:'Grand Slam Edition',desc:'Worn by champions',stats:{power:8,speed:35,control:25},price:120,currency:'gems'}
    ],
    serve:[
        {id:'sv1',name:'Serve Basics',desc:'Learn proper toss technique',stats:{serve:10,skillPoints:50},price:200,currency:'coins',repeatable:true},
        {id:'sv2',name:'Power Serve Training',desc:'Add MPH to your first serve',stats:{serve:15,power:5},price:400,currency:'coins'},
        {id:'sv3',name:'Kick Serve Clinic',desc:'Master the topspin serve',stats:{serve:20,control:10},price:600,currency:'coins'},
        {id:'sv4',name:'Ace Machine',desc:'Premium serve accuracy boost',stats:{serve:30,control:15},price:80,currency:'gems'},
        {id:'sv5',name:'Serve & Volley Pack',desc:'Complete approach game',stats:{serve:25,speed:15,power:10},price:1000,currency:'coins'},
        {id:'sv6',name:'Pro Serve Masterclass',desc:'Tour-level serving',stats:{serve:40,power:15,control:20},price:150,currency:'gems'}
    ],
    special:[
        {id:'x1',name:'Lucky Charm',desc:'2x coin rewards',stats:{bonus:'2x Coins'},price:150,currency:'gems'},
        {id:'x2',name:'Power Band',desc:'Massive power boost',stats:{power:40},price:50,currency:'gems'},
        {id:'x3',name:'Focus Lens',desc:'Larger hit window',stats:{control:50},price:200,currency:'gems'},
        {id:'x4',name:'Energy Drink',desc:'Faster court coverage',stats:{speed:25},price:30,currency:'gems'},
        {id:'x5',name:'Sweatband Pro',desc:'Balanced improvement',stats:{power:10,speed:10,control:10,serve:10},price:80,currency:'gems'},
        {id:'x6',name:'Tournament Trophy',desc:'Prestige item - all stats',stats:{power:20,speed:20,control:20,serve:20},price:300,currency:'gems'},
        {id:'x7',name:'Gem Magnet',desc:'Gems last 50% longer',stats:{bonus:'Gem Duration+'},price:100,currency:'gems'},
        {id:'x8',name:'Streak Master',desc:'Streaks give 2x bonus',stats:{bonus:'2x Streak'},price:120,currency:'gems'}
    ],
    training:[
        {id:'t1',name:'Private Coaching',desc:'1-on-1 with a pro coach',stats:{skillPoints:100,power:3,control:3},price:250,currency:'coins',repeatable:true},
        {id:'t2',name:'Group Clinic',desc:'Learn with other players',stats:{skillPoints:50,power:2,speed:1},price:100,currency:'coins',repeatable:true},
        {id:'t3',name:'Ball Machine',desc:'Perfect your groundstrokes',stats:{skillPoints:75,control:4,speed:1},price:150,currency:'coins',repeatable:true},
        {id:'t4',name:'Hit with a Friend',desc:'Casual practice session',stats:{skillPoints:30,power:1,speed:1,control:1},price:50,currency:'coins',repeatable:true},
        {id:'t5',name:'Flex League',desc:'Competitive match play',stats:{skillPoints:200,power:5,speed:3,control:5},price:500,currency:'coins',repeatable:true},
        {id:'t6',name:'Elite Camp',desc:'Intensive weekend program',stats:{skillPoints:500,power:10,speed:10,control:10,serve:5},price:150,currency:'gems',repeatable:true},
        {id:'t7',name:'Video Analysis',desc:'Study your technique',stats:{skillPoints:150,control:8,power:4},price:350,currency:'coins',repeatable:true},
        {id:'t8',name:'Fitness Bootcamp',desc:'Build court endurance',stats:{skillPoints:120,speed:7,power:5},price:300,currency:'coins',repeatable:true}
    ]
};

// Difficulty settings with serve parameters
const DIFF={
    rookie:{speed:1.1,oppSpeed:0.07,hitWindow:0.38,oppAcc:0.65,mult:1,time:120,serveFaultChance:0.15,oppServeSpeed:0.8},
    pro:{speed:1.5,oppSpeed:0.11,hitWindow:0.28,oppAcc:0.8,mult:2,time:150,serveFaultChance:0.25,oppServeSpeed:1.0},
    legend:{speed:2,oppSpeed:0.16,hitWindow:0.18,oppAcc:0.92,mult:3,time:180,serveFaultChance:0.35,oppServeSpeed:1.2}
};

// Match state with proper tennis rules
let M={
    active:false,
    // Scoring
    pPoints:0,oPoints:0,  // Points in current game (0,1,2,3 = 0,15,30,40)
    pGames:0,oGames:0,    // Games in current set
    pSets:0,oSets:0,      // Sets (optional for longer matches)
    time:120,
    isTiebreak:false,     // Special scoring in tiebreak
    tiebreakServer:'player', // Who serves first in tiebreak
    // Serve state
    isServing:true,       // Is player serving this game?
    serveNum:1,           // 1 = first serve, 2 = second serve
    serveSide:'deuce',    // 'deuce' (right) or 'ad' (left)
    isPlayerServe:false,  // True when player needs to serve
    servingPlayer:'opp',  // 'player' or 'opp' - who is serving this game
    servePhase:'none',    // 'none', 'ready', 'toss', 'swing', 'flight'
    servePower:0,
    serveAimX:50,
    serveAimY:25,
    serveStartY:null,
    lastServeSpeed:0,     // MPH for display
    // Ball state
    rally:0,
    ballActive:false,
    ballPos:{x:50,y:10},
    ballVel:{x:0,y:0,z:0},
    ballH:100,
    ballBounces:0,
    ballSpin:0,           // Spin effect
    canHit:false,
    combo:0,
    streak:0,             // Consecutive points won
    // Positions
    oppPos:50,
    playerPos:50,
    // Gems
    gemActive:false,
    gemPos:{x:50,y:70},
    gemTimer:0,
    gemMultiplier:1,
    // Stats
    aces:0,
    doubleFaults:0,
    winners:0,
    longestRally:0,
    totalRallies:0,
    pointsPlayed:0,
    // Settings
    settings:null
};

let audio,sounds={};

function initAudio(){
    audio=new(window.AudioContext||window.webkitAudioContext)();
    sounds.hit=()=>playTone(150,0.03,0.4);
    sounds.bounce=()=>playTone(100,0.02,0.3);
    sounds.point=()=>{playTone(440,0.1,0.3);setTimeout(()=>playTone(880,0.15,0.3),100)};
    sounds.miss=()=>playTone(80,0.2,0.2);
    sounds.coin=()=>{playTone(1200,0.05,0.25);setTimeout(()=>playTone(1600,0.05,0.25),40)};
    sounds.gem=()=>{playTone(1800,0.08,0.3);setTimeout(()=>playTone(2200,0.08,0.3),50)};
    sounds.serve=()=>{playTone(200,0.04,0.5);setTimeout(()=>playTone(400,0.06,0.4),30)};
    sounds.fault=()=>{playTone(150,0.15,0.3);setTimeout(()=>playTone(100,0.2,0.25),100)};
    sounds.ace=()=>{playTone(600,0.1,0.4);setTimeout(()=>playTone(900,0.1,0.4),80);setTimeout(()=>playTone(1200,0.15,0.4),160)};
    sounds.let=()=>{playTone(300,0.1,0.3);setTimeout(()=>playTone(300,0.1,0.3),150)};
    sounds.changeover=()=>{playTone(400,0.15,0.25);setTimeout(()=>playTone(500,0.15,0.25),100);setTimeout(()=>playTone(600,0.2,0.25),200)};
    sounds.winner=()=>{playTone(800,0.1,0.35);setTimeout(()=>playTone(1000,0.1,0.35),80);setTimeout(()=>playTone(1200,0.15,0.35),160)};
}

function playTone(f,d,v){
    if(!audio)return;
    const o=audio.createOscillator(),g=audio.createGain();
    o.frequency.value=f;
    o.connect(g);
    g.connect(audio.destination);
    g.gain.setValueAtTime(v,audio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01,audio.currentTime+d);
    o.start();
    o.stop(audio.currentTime+d);
}

// ========== GEM SYSTEM ==========

function spawnGem(){
    if(!M.active||M.gemActive)return;
    
    // Calculate multiplier based on streak
    const streakBonus = G.owned.includes('x8') ? 2 : 1;
    M.gemMultiplier = Math.min(5, 1 + Math.floor(M.streak / 2) * streakBonus);
    
    M.gemActive=true;
    M.gemPos={x:20+Math.random()*60,y:55+Math.random()*30};
    
    // Gem duration - base 8 seconds, +50% with Gem Magnet
    const baseDuration = 8;
    M.gemTimer = G.owned.includes('x7') ? Math.floor(baseDuration * 1.5) : baseDuration;
    
    const gem=document.getElementById('gemDrop');
    const timerEl=document.getElementById('gemTimer');
    const multEl=document.getElementById('gemMultiplier');
    
    gem.classList.add('active');
    gem.classList.remove('urgent');
    gem.style.left=M.gemPos.x+'%';
    gem.style.top=M.gemPos.y+'%';
    
    multEl.textContent = 'x' + M.gemMultiplier;
    multEl.style.display = M.gemMultiplier > 1 ? 'block' : 'none';
    
    updateGemTimer();
    
    const interval=setInterval(()=>{
        M.gemTimer--;
        updateGemTimer();
        
        // Urgent animation when < 3 seconds
        if(M.gemTimer <= 3 && M.gemTimer > 0){
            gem.classList.add('urgent');
        }
        
        if(M.gemTimer<=0||!M.active){
            clearInterval(interval);
            hideGem();
        }
    },1000);
}

function updateGemTimer(){
    const timerEl=document.getElementById('gemTimer');
    timerEl.textContent = M.gemTimer + 's';
}

function hideGem(){
    M.gemActive=false;
    const gem=document.getElementById('gemDrop');
    gem.classList.remove('active','urgent');
}

function collectGem(){
    if(!M.gemActive)return;
    
    const baseGems = Math.floor(Math.random()*3)+1;
    const totalGems = baseGems * M.gemMultiplier;
    
    G.gems+=totalGems;
    
    // Create burst particles
    const gem = document.getElementById('gemDrop');
    const rect = gem.getBoundingClientRect();
    const court = document.querySelector('.court');
    const courtRect = court.getBoundingClientRect();
    
    for(let i = 0; i < 8; i++){
        const particle = document.createElement('div');
        particle.className = 'gem-particle';
        const angle = (i / 8) * Math.PI * 2;
        const dist = 40 + Math.random() * 30;
        particle.style.cssText = `
            left: ${((rect.left + rect.width/2 - courtRect.left) / courtRect.width) * 100}%;
            top: ${((rect.top + rect.height/2 - courtRect.top) / courtRect.height) * 100}%;
            --tx: ${Math.cos(angle) * dist}px;
            --ty: ${Math.sin(angle) * dist}px;
            animation: gemBurst 0.5s ease-out forwards;
        `;
        court.appendChild(particle);
        setTimeout(() => particle.remove(), 500);
    }
    
    M.gemActive=false;
    gem.classList.remove('active','urgent');
    sounds.gem();
    
    if(M.gemMultiplier > 1){
        toast(`+${totalGems} üíé (x${M.gemMultiplier})`);
    } else {
        toast(`+${totalGems} üíé`);
    }
    
    save();
    updateUI();
}

function updateStreakDisplay(){
    const display = document.getElementById('streakDisplay');
    const valueEl = document.getElementById('streakValue');
    const bonusEl = document.getElementById('streakBonus');
    
    if(M.streak >= 2){
        display.classList.add('active');
        valueEl.textContent = M.streak;
        const bonusPercent = Math.min(200, M.streak * 25);
        bonusEl.textContent = `+${bonusPercent}% gems`;
    } else {
        display.classList.remove('active');
    }
}

// ========== SERVE SYSTEM ==========

function getServeSide(){
    // In tennis: deuce court (right) on even points, ad court (left) on odd points
    const totalPoints = M.pPoints + M.oPoints;
    return totalPoints % 2 === 0 ? 'deuce' : 'ad';
}

function getTiebreakServer(){
    // In tiebreak: first server serves 1 point, then alternate every 2 points
    const totalPoints = M.pPoints + M.oPoints;
    if(totalPoints === 0) return M.tiebreakServer;
    // After first point, switch every 2 points
    const adjustedPoints = totalPoints - 1;
    const switches = Math.floor(adjustedPoints / 2) + 1;
    return switches % 2 === 0 ? M.tiebreakServer : (M.tiebreakServer === 'player' ? 'opp' : 'player');
}

function showNetCordEffect(){
    const netCord = document.getElementById('netCord');
    netCord.classList.remove('active');
    void netCord.offsetWidth;
    netCord.classList.add('active');
    setTimeout(() => netCord.classList.remove('active'), 400);
}

function showCallOverlay(text, isGood){
    const overlay = document.getElementById('callOverlay');
    overlay.textContent = text;
    overlay.classList.remove('active', 'in');
    void overlay.offsetWidth;
    if(isGood) overlay.classList.add('in');
    overlay.classList.add('active');
    setTimeout(() => overlay.classList.remove('active', 'in'), 800);
}

function showCourtChange(message, sub){
    return new Promise(resolve => {
        const overlay = document.getElementById('courtChange');
        document.getElementById('courtChangeText').textContent = message;
        document.getElementById('courtChangeSub').textContent = sub || '';
        overlay.classList.add('active');
        sounds.changeover();
        setTimeout(() => {
            overlay.classList.remove('active');
            resolve();
        }, 2000);
    });
}

function shouldChangeover(){
    // In tennis, players change sides after every odd game (1, 3, 5, etc.)
    const totalGames = M.pGames + M.oGames;
    return totalGames > 0 && totalGames % 2 === 1;
}

function updateServeIndicator(){
    const ind = document.getElementById('serveIndicator');
    if(M.serveNum === 1){
        ind.textContent = '1ST SERVE';
        ind.classList.remove('fault');
    } else {
        ind.textContent = '2ND SERVE';
        ind.classList.add('fault');
    }
}

function highlightServiceBox(){
    const deuce = document.getElementById('serviceBoxDeuce');
    const ad = document.getElementById('serviceBoxAd');
    
    deuce.classList.remove('active');
    ad.classList.remove('active');
    
    M.serveSide = getServeSide();
    
    if(M.serveSide === 'deuce'){
        deuce.classList.add('active');
    } else {
        ad.classList.add('active');
    }
}

function clearServiceBoxHighlight(){
    document.getElementById('serviceBoxDeuce').classList.remove('active');
    document.getElementById('serviceBoxAd').classList.remove('active');
}

function startPlayerServe(){
    M.isPlayerServe = true;
    M.servePhase = 'ready';
    M.servePower = 0;
    M.serveStartY = null;
    M.serveStartX = null;
    M.serveAimX = M.serveSide === 'deuce' ? 68 : 32; // Default aim to box center
    
    // Position player at baseline center
    M.playerPos = 50;
    document.getElementById('playerPaddle').style.left = '50%';
    document.getElementById('playerPaddle').classList.add('serving');
    
    // Show serve UI
    highlightServiceBox();
    updateServeIndicator();
    
    const hint = document.getElementById('swipeHint');
    hint.textContent = 'PULL DOWN TO SERVE';
    hint.classList.add('active','serve');
    
    // Position ball with player
    const ball = document.getElementById('ball');
    ball.classList.add('active');
    ball.style.left = '50%';
    ball.style.top = '88%';
    
    document.getElementById('ballShadow').classList.add('active');
    document.getElementById('ballShadow').style.left = '50%';
    document.getElementById('ballShadow').style.top = '92%';
}

function chargingServe(clientY, clientX){
    if(M.servePhase !== 'ready' && M.servePhase !== 'charging') return;
    
    if(M.serveStartY === null){
        M.serveStartY = clientY;
        M.serveStartX = clientX;
        M.servePhase = 'charging';
        document.getElementById('servePower').classList.add('active');
        document.getElementById('serveAim').classList.add('active');
        document.getElementById('serveTargetLine').classList.add('active');
    }
    
    // Calculate power based on pull-down distance
    const pullDist = clientY - M.serveStartY;
    M.servePower = Math.min(1, Math.max(0, pullDist / 150));
    
    document.getElementById('servePowerFill').style.width = (M.servePower * 100) + '%';
    
    // Update aim indicator position based on horizontal movement
    const court = document.querySelector('.court');
    if(court && clientX){
        const rect = court.getBoundingClientRect();
        const relX = ((clientX - rect.left) / rect.width) * 100;
        
        // Calculate target position in service box
        const isDeuce = M.serveSide === 'deuce';
        const boxLeft = isDeuce ? 52 : 15;
        const boxRight = isDeuce ? 85 : 48;
        const boxCenter = (boxLeft + boxRight) / 2;
        
        // Aim influenced by finger position
        const aimOffset = (relX - 50) * 0.4;
        const targetX = Math.max(boxLeft, Math.min(boxRight, boxCenter + aimOffset));
        
        M.serveAimX = targetX;
        
        // Position aim indicator
        const aimEl = document.getElementById('serveAim');
        aimEl.style.left = targetX + '%';
        aimEl.style.top = '35%';
        
        // Position target line from player to aim
        const lineEl = document.getElementById('serveTargetLine');
        lineEl.style.left = '50%';
        lineEl.style.bottom = '10%';
        lineEl.style.height = '50%';
        const angle = Math.atan2(targetX - 50, 50) * (180 / Math.PI);
        lineEl.style.transform = `rotate(${angle}deg)`;
    }
}

function releaseServe(endX, endY){
    if(M.servePhase !== 'charging') return;
    
    M.servePhase = 'swing';
    
    // Hide charging UI
    document.getElementById('servePower').classList.remove('active');
    document.getElementById('swipeHint').classList.remove('active','serve');
    document.getElementById('playerPaddle').classList.remove('serving');
    document.getElementById('serveAim').classList.remove('active');
    document.getElementById('serveTargetLine').classList.remove('active');
    
    // Use the aim target position we've been tracking
    const aimX = M.serveAimX || 50;
    
    // Execute serve with power and aim
    executePlayerServe(M.servePower, aimX);
}

function executePlayerServe(power, aimX){
    const st = getStats();
    
    // Ball toss animation
    const ball = document.getElementById('ball');
    ball.classList.add('toss');
    
    sounds.serve();
    
    // Play serve animation
    document.getElementById('playerSprite').style.backgroundImage = `url(${SPRITES.playerSwing})`;
    document.getElementById('playerSprite').style.backgroundSize = '640px 96px';
    playSprite('playerSprite', 8);
    
    setTimeout(() => {
        ball.classList.remove('toss');
        
        // Determine target service box
        const isDeuceCourt = M.serveSide === 'deuce';
        const boxCenterX = isDeuceCourt ? 65 : 35;
        const boxLeft = isDeuceCourt ? 50 : 12;
        const boxRight = isDeuceCourt ? 88 : 50;
        
        // Calculate serve trajectory
        // Aim target is where player was aiming (tracked in M.serveAimX)
        const serveAccuracy = st.serve / 100;
        const aimTarget = aimX; // This is the aim position player targeted
        const randomSpread = (Math.random() - 0.5) * (30 - serveAccuracy * 25);
        
        // Higher serve stat = closer to intended target
        let targetX = aimTarget + randomSpread * (1 - serveAccuracy * 0.5);
        
        // Power affects speed and fault chance
        const baseSpeed = 1.5 + power * 1.5;
        const serveSpeed = baseSpeed * (1 + st.serve * 0.005) * M.settings.speed * 0.7;
        
        // Fault detection
        const faultChance = M.settings.serveFaultChance * (1 - serveAccuracy * 0.5) * (power > 0.8 ? 1.3 : 1);
        const isNetFault = power < 0.2 || Math.random() < faultChance * 0.3;
        const isOutFault = targetX < boxLeft - 5 || targetX > boxRight + 5 || Math.random() < faultChance * 0.4;
        
        // Calculate serve speed for display (80-140 MPH range based on power and serve stat)
        const baseServeSpeed = 80 + power * 40 + st.serve * 0.2;
        M.lastServeSpeed = Math.round(baseServeSpeed + (Math.random() - 0.5) * 10);
        document.getElementById('serveSpeed').textContent = M.lastServeSpeed + ' MPH';
        
        // Let serve (hits net but goes over - replay)
        const isLet = !isNetFault && Math.random() < 0.05;
        
        if(isLet){
            sounds.let();
            showNetCordEffect();
            toast('LET! Serve again');
            M.servePhase = 'none';
            setTimeout(startPlayerServe, 1000);
            return;
        }
        
        if(isNetFault){
            handleServeFault('net');
            return;
        }
        
        if(isOutFault){
            // Commit to serve but it goes out
            M.ballActive = true;
            M.ballPos = {x: 50, y: 90};
            M.ballH = 40;
            M.ballBounces = 0;
            targetX = targetX < boxCenterX ? boxLeft - 10 : boxRight + 10;
            M.ballVel = {
                x: (targetX - M.ballPos.x) / 80,
                y: -serveSpeed,
                z: 2.0
            };
            animateServeBall('out');
            return;
        }
        
        // Good serve!
        M.ballActive = true;
        M.ballPos = {x: 50, y: 88};
        M.ballH = 60;
        M.ballBounces = 0;
        M.isPlayerServe = false;
        M.servePhase = 'flight';
        
        clearServiceBoxHighlight();
        
        M.ballVel = {
            x: (targetX - M.ballPos.x) / 70,
            y: -serveSpeed,
            z: 2.2
        };
        
        // Check if it's an ace (opponent can't reach)
        const aceChance = power * serveAccuracy * 0.15;
        M.pendingAce = Math.random() < aceChance;
        
        animateServeBall('good');
        
    }, 400); // Delay for toss animation
}

function animateServeBall(result){
    if(!M.ballActive) return;
    
    M.ballPos.x += M.ballVel.x;
    M.ballPos.y += M.ballVel.y;
    M.ballH += M.ballVel.z;
    M.ballVel.z -= 0.12;
    
    // Ground bounce
    if(M.ballH <= 0 && M.ballVel.z < 0){
        M.ballH = 0;
        M.ballVel.z = -M.ballVel.z * 0.6;
        sounds.bounce();
        M.ballBounces++;
        
        // Check if ball landed in/out after first bounce
        if(M.ballBounces === 1 && result === 'out'){
            handleServeFault('out');
            return;
        }
        
        // Ball in play after bounce
        if(M.ballBounces === 1 && result === 'good'){
            M.servePhase = 'none';
            // Now it becomes a rally - opponent tries to return
        }
    }
    
    const ball = document.getElementById('ball');
    const shadow = document.getElementById('ballShadow');
    ball.style.left = M.ballPos.x + '%';
    ball.style.top = (M.ballPos.y - M.ballH/12) + '%';
    shadow.style.left = M.ballPos.x + '%';
    shadow.style.top = M.ballPos.y + '%';
    
    // Ball crossed net - opponent's turn
    if(M.ballPos.y < 45 && M.servePhase === 'flight'){
        // Opponent tries to return
        if(M.pendingAce){
            // ACE!
            M.ballActive = false;
            resetBallUI();
            M.aces++;
            sounds.ace();
            showCallOverlay('ACE!', true);
            M.streak++;
            updateStreakDisplay();
            if(!scorePoint('p')) setTimeout(startNextPoint, 2000);
            return;
        }
        
        // Opponent returns - transition to normal rally
        M.servePhase = 'none';
        opponentReturn();
        return;
    }
    
    // Ball out of bounds
    if(M.ballPos.y < 5 || M.ballPos.x < 5 || M.ballPos.x > 95){
        if(result === 'out'){
            handleServeFault('out');
        } else {
            // Opponent missed - point for player
            M.ballActive = false;
            resetBallUI();
            sounds.point();
            M.streak++;
            updateStreakDisplay();
            if(!scorePoint('p')) setTimeout(startNextPoint, 1200);
        }
        return;
    }
    
    updateOpp();
    requestAnimationFrame(() => animateServeBall(result));
}

function handleServeFault(type){
    M.ballActive = false;
    resetBallUI();
    clearServiceBoxHighlight();
    sounds.fault();
    
    if(M.serveNum === 1){
        // First serve fault - get second serve
        M.serveNum = 2;
        showCallOverlay('FAULT', false);
        setTimeout(startPlayerServe, 1500);
    } else {
        // Double fault - lose point
        M.serveNum = 1;
        M.doubleFaults++;
        showCallOverlay('DOUBLE FAULT', false);
        M.streak = 0;
        updateStreakDisplay();
        if(!scorePoint('o')) setTimeout(startNextPoint, 2000);
    }
}

function opponentReturn(){
    // Opponent hits the ball back
    const st = getStats();
    M.rally++;
    updateMatchUI();
    
    const oppDist = Math.abs(M.ballPos.x - M.oppPos);
    const canReach = oppDist < 35;
    
    if(!canReach){
        // Opponent can't reach - point for player (might be from ace-like serve)
        M.ballActive = false;
        resetBallUI();
        sounds.point();
        M.streak++;
        updateStreakDisplay();
        if(!scorePoint('p')) setTimeout(startNextPoint, 1200);
        return;
    }
    
    // Opponent hits back
    M.oppPos = M.ballPos.x;
    document.getElementById('opponent').style.left = M.oppPos + '%';
    document.getElementById('opponent').classList.add('hitting');
    setOppSwinging();
    setTimeout(() => document.getElementById('opponent').classList.remove('hitting'), 250);
    sounds.hit();
    
    M.ballBounces = 0;
    M.ballH = 50;
    
    const targetX = M.playerPos + (Math.random() - 0.5) * 40;
    M.ballVel = {
        x: (targetX - M.ballPos.x) / 90,
        y: M.settings.speed * 0.55,
        z: 1.8
    };
    
    // Now normal rally begins
    animateBall();
}

// ========== OPPONENT SERVE ==========

function opponentServe(){
    if(!M.active) return;
    
    highlightServiceBox();
    updateServeIndicator();
    
    // Opponent prepares to serve
    const oppServeDelay = 800;
    
    setTimeout(() => {
        if(!M.active) return;
        
        clearServiceBoxHighlight();
        
        M.ballActive = true;
        M.ballPos = {x: M.oppPos, y: 10};
        M.ballH = 80;
        M.ballBounces = 0;
        
        const st = getStats();
        const isDeuceCourt = M.serveSide === 'deuce';
        const targetX = isDeuceCourt ? 55 + Math.random() * 20 : 25 + Math.random() * 20;
        
        // Opponent serve speed
        const serveSpd = M.settings.speed * M.settings.oppServeSpeed * 0.65;
        
        // Display opponent serve speed (slightly faster than player typically)
        const oppServeSpeed = Math.round(90 + M.settings.oppServeSpeed * 30 + Math.random() * 15);
        M.lastServeSpeed = oppServeSpeed;
        document.getElementById('serveSpeed').textContent = oppServeSpeed + ' MPH';
        
        M.ballVel = {
            x: (targetX - M.ballPos.x) / 100 * 1.1,
            y: serveSpd,
            z: 1.2
        };
        
        const ball = document.getElementById('ball');
        const shadow = document.getElementById('ballShadow');
        ball.classList.add('active');
        shadow.classList.add('active');
        
        document.getElementById('opponent').classList.add('hitting');
        setOppSwinging();
        setTimeout(() => document.getElementById('opponent').classList.remove('hitting'), 250);
        sounds.serve();
        
        animateBall();
    }, oppServeDelay);
}

// ========== CORE GAME FUNCTIONS ==========

function startGame(){
    if(!audio) initAudio();
    document.getElementById('loadingScreen').classList.remove('active');
    document.getElementById('mainMenu').classList.add('active');
    load();
    updateUI();
}

function load(){
    const s = localStorage.getItem('tennisGame');
    if(s){
        const saved = JSON.parse(s);
        Object.assign(G, saved);
        // Ensure new stats exist
        if(!G.stats.serve) G.stats.serve = 10;
        if(!G.equipment.serveGear) G.equipment.serveGear = null;
    }
}

function save(){
    localStorage.setItem('tennisGame', JSON.stringify(G));
}

function getStats(){
    const s = {...G.stats};
    Object.values(SHOP).flat().forEach(i => {
        if(G.owned.includes(i.id) && Object.values(G.equipment).includes(i.id)){
            if(i.stats.power) s.power += i.stats.power;
            if(i.stats.speed) s.speed += i.stats.speed;
            if(i.stats.control) s.control += i.stats.control;
            if(i.stats.serve) s.serve += i.stats.serve;
        }
    });
    // Also add stats from non-equipment owned items (like serve training)
    SHOP.serve.forEach(i => {
        if(G.owned.includes(i.id) && !i.repeatable){
            if(i.stats.serve) s.serve += i.stats.serve;
            if(i.stats.power) s.power += i.stats.power;
            if(i.stats.control) s.control += i.stats.control;
        }
    });
    return s;
}

const NTRP_LEVELS=[
    {rating:2.5,points:0},
    {rating:3.0,points:300},
    {rating:3.5,points:800},
    {rating:4.0,points:1500},
    {rating:4.5,points:2500},
    {rating:5.0,points:4000},
    {rating:5.5,points:6000}
];

function getNTRP(){
    for(let i=NTRP_LEVELS.length-1;i>=0;i--){
        if(G.skillPoints>=NTRP_LEVELS[i].points) return NTRP_LEVELS[i].rating;
    }
    return 2.5;
}

function getNextNTRP(){
    const current = getNTRP();
    const idx = NTRP_LEVELS.findIndex(l => l.rating === current);
    if(idx < NTRP_LEVELS.length - 1) return NTRP_LEVELS[idx + 1];
    return null;
}

function updateUI(){
    const ntrp = getNTRP();
    const next = getNextNTRP();
    G.ntrp = ntrp;
    
    document.getElementById('playerNTRP').textContent = ntrp.toFixed(1);
    document.getElementById('coinAmount').textContent = G.coins;
    document.getElementById('gemAmount').textContent = G.gems;
    document.getElementById('skillPoints').textContent = G.skillPoints;
    
    if(next){
        document.getElementById('skillNeeded').textContent = next.points;
        const progress = (G.skillPoints / next.points) * 100;
        document.getElementById('skillFill').style.width = progress + '%';
    } else {
        document.getElementById('skillNeeded').textContent = 'MAX';
        document.getElementById('skillFill').style.width = '100%';
    }
    
    const s = getStats();
    document.getElementById('statPower').textContent = s.power;
    document.getElementById('statSpeed').textContent = s.speed;
    document.getElementById('statControl').textContent = s.control;
    document.getElementById('statServe').textContent = s.serve;
}

function selectDifficulty(d){
    G.difficulty = d;
    document.querySelectorAll('.diff-rookie,.diff-pro,.diff-legend').forEach(b => b.classList.remove('selected'));
    document.querySelector('.diff-' + d).classList.add('selected');
}

function selectMatchType(type){
    G.matchType = type;
    document.getElementById('matchQuick').classList.remove('selected');
    document.getElementById('matchStandard').classList.remove('selected');
    document.getElementById('matchTimed').classList.remove('selected');
    document.getElementById('match' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('selected');
}

function showShop(){
    document.getElementById('mainMenu').classList.remove('active');
    document.getElementById('shopScreen').classList.add('active');
    renderShop('training');
}

function closeShop(){
    document.getElementById('shopScreen').classList.remove('active');
    document.getElementById('mainMenu').classList.add('active');
    updateUI();
}

// Character system - must be before showCharSelect
const V = '?v=26';

window.CHARACTERS = [
    {id:'player1', name:'Roger Fedora', power:50, speed:50, control:50, unlocked:true},
    {id:'player2', name:'Serena Will-yams', power:45, speed:55, control:50, unlocked:true},
    {id:'player3', name:'Pete Shampoo', power:55, speed:45, control:50, unlocked:true},
    {id:'player4', name:'Steffi Gaffe', power:45, speed:60, control:45, unlocked:true},
    {id:'player5', name:'Rafa Noddle', power:65, speed:40, control:45, unlocked:false, cost:500},
    {id:'player6', name:'Martina N.T.O.', power:40, speed:55, control:55, unlocked:false, cost:500},
    {id:'player7', name:'Bjorn Bored', power:45, speed:45, control:60, unlocked:false, cost:750},
    {id:'player8', name:'Venus Will-yams', power:50, speed:55, control:45, unlocked:false, cost:750},
    {id:'player9', name:'Boris Bonkers', power:60, speed:35, control:55, unlocked:false, cost:1000},
    {id:'player10', name:'Chris Ev-hurt', power:45, speed:50, control:55, unlocked:false, cost:1000},
    {id:'player11', name:'Andre A-gassy', power:50, speed:60, control:40, unlocked:false, cost:1250},
    {id:'player12', name:'Naomi Oh-saka', power:40, speed:55, control:55, unlocked:false, cost:1250},
    {id:'punk', name:'John Mac-n-Throw', power:70, speed:50, control:30, unlocked:false, cost:2000, special:true},
    {id:'chubby', name:'Jimmy Con-ers', power:75, speed:30, control:45, unlocked:false, cost:2000, special:true},
    {id:'beach', name:'Maria Shara-Pova', power:40, speed:65, control:45, unlocked:false, cost:2000, special:true},
    {id:'goth', name:'Monica Slay-less', power:55, speed:45, control:50, unlocked:false, cost:2500, special:true},
    {id:'grandpa', name:'Rod Layer', power:35, speed:35, control:80, unlocked:false, cost:2500, special:true},
    {id:'indian', name:'Sania Mirr-za', power:50, speed:50, control:50, unlocked:false, cost:2500, special:true},
    {id:'anime', name:'Nick Curious', power:55, speed:65, control:30, unlocked:false, cost:3000, special:true},
    {id:'latino', name:'Carlos All-Crazz', power:60, speed:55, control:35, unlocked:false, cost:3000, special:true},
    {id:'redhead', name:'Billie Jean Queen', power:50, speed:55, control:45, unlocked:false, cost:3000, special:true}
];

var selectedChar = window.CHARACTERS[0];

function getCharSprites(char){
    // Only player1 uses legacy sprites; everyone else has unique sprites in sprites-v2/characters/
    if(char.id === 'player1'){
        return {
            playerSwing: 'player-retro-backswing.png' + V,
            playerRun: 'player-retro-run.png' + V,
            playerIdle: 'player-idle-v2.png' + V,
            oppSwing: 'opponent-retro-frontswing.png' + V,
            oppRun: 'opponent-retro-run.png' + V,
            oppIdle: 'opponent-idle-v2.png' + V
        };
    }
    const base = 'sprites-v2/characters/' + char.id + '-';
    return {
        playerSwing: base + 'back-swing.png' + V,
        playerRun: base + 'back-run.png' + V,
        playerIdle: base + 'back-swing.png' + V,
        oppSwing: base + 'front-swing.png' + V,
        oppRun: base + 'front-run.png' + V,
        oppIdle: base + 'front-swing.png' + V
    };
}

const SPRITES = getCharSprites(selectedChar);

function updateSprites(){
    const s = getCharSprites(selectedChar);
    Object.assign(SPRITES, s);
}

function showCharSelect(){
    document.getElementById('mainMenu').classList.remove('active');
    document.getElementById('charSelect').classList.add('active');
    renderCharGrid();
    if(selectedChar) selectCharacter(selectedChar);
}

function closeCharSelect(){
    document.getElementById('charSelect').classList.remove('active');
    document.getElementById('mainMenu').classList.add('active');
}

function renderCharGrid(){
    var grid = document.getElementById('charGrid');
    if(!grid) return;
    var chars = window.CHARACTERS;
    if(!chars || !chars.length) return;
    var html = '';
    var V = '?v=26';
    for(var i = 0; i < chars.length; i++){
        var c = chars[i];
        var unlocked = c.unlocked || (window.G && window.G.unlockedChars && window.G.unlockedChars.indexOf(c.id) >= 0);
        var spriteUrl = c.id === 'player1' ? 'player-retro-backswing.png' + V : 'sprites-v2/characters/' + c.id + '-back-swing.png' + V;
        var isSelected = selectedChar && selectedChar.id === c.id;
        html += '<div class="char-card' + (isSelected ? ' selected' : '') + (unlocked ? '' : ' locked') + '" ';
        html += 'onclick="' + (unlocked ? 'selectCharacter(window.CHARACTERS[' + i + '])' : 'tryUnlock(\'' + c.id + '\')') + '">';
        html += '<div class="char-preview" style="background-image:url(' + spriteUrl + ')"></div>';
        if(unlocked){
            html += '<div class="char-name">' + c.name + '</div>';
            html += '<div class="char-stat-bars">';
            html += '<div class="stat-bar-row"><span class="stat-lbl">P</span><div class="stat-bar"><div class="stat-fill pwr" style="width:' + c.power + '%"></div></div></div>';
            html += '<div class="stat-bar-row"><span class="stat-lbl">S</span><div class="stat-bar"><div class="stat-fill spd" style="width:' + c.speed + '%"></div></div></div>';
            html += '<div class="stat-bar-row"><span class="stat-lbl">C</span><div class="stat-bar"><div class="stat-fill ctl" style="width:' + c.control + '%"></div></div></div>';
            html += '</div>';
        } else {
            html += '<div class="char-lock">üîí</div>';
            html += '<div class="char-name">' + c.cost + 'üí∞</div>';
        }
        html += '</div>';
    }
    grid.innerHTML = html;
}

function selectCharacter(char){
    selectedChar = char;
    document.querySelectorAll('.char-card').forEach((el,i) => 
        el.classList.toggle('selected', window.CHARACTERS[i].id === char.id));
    const sprites = getCharSprites(char);
    document.getElementById('charDetailPreview').style.backgroundImage = `url(${sprites.playerSwing})`;
    document.getElementById('charDetailName').textContent = char.name.toUpperCase();
    document.getElementById('charPower').textContent = char.power;
    document.getElementById('charSpeed').textContent = char.speed;
    document.getElementById('charControl').textContent = char.control;
}

function confirmCharacter(){
    updateSprites();
    closeCharSelect();
    toast(`${selectedChar.name} selected!`);
}

function tryUnlock(id){
    var char = window.CHARACTERS.find(function(c) { return c.id === id; });
    if(G.coins >= char.cost){
        G.coins -= char.cost;
        G.unlockedChars = G.unlockedChars || [];
        G.unlockedChars.push(id);
        save();
        renderCharGrid();
        selectCharacter(char);
        toast(`${char.name} unlocked!`);
    } else {
        toast('Not enough coins!');
    }
}

function switchTab(cat, btn){
    document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    renderShop(cat);
}

function renderShop(cat){
    const c = document.getElementById('shopItems');
    c.innerHTML = '';
    
    const items = SHOP[cat] || [];
    
    items.forEach(item => {
        const owned = G.owned.includes(item.id);
        const equipped = Object.values(G.equipment).includes(item.id);
        const canBuy = (item.currency === 'gems' ? G.gems : G.coins) >= item.price;
        const isTraining = cat === 'training' || (cat === 'serve' && item.repeatable);
        const isServeEquip = cat === 'serve' && !item.repeatable;
        
        let statsHTML = '';
        if(item.stats.skillPoints) statsHTML += `<span class="item-stat">+${item.stats.skillPoints} Skill</span>`;
        if(item.stats.power) statsHTML += `<span class="item-stat">+${item.stats.power} PWR</span>`;
        if(item.stats.speed) statsHTML += `<span class="item-stat">+${item.stats.speed} SPD</span>`;
        if(item.stats.control) statsHTML += `<span class="item-stat">+${item.stats.control} CTL</span>`;
        if(item.stats.serve) statsHTML += `<span class="item-stat">+${item.stats.serve} SRV</span>`;
        if(item.stats.bonus) statsHTML += `<span class="item-stat">${item.stats.bonus}</span>`;
        
        const d = document.createElement('div');
        d.className = 'shop-item' + (owned && !isTraining ? ' owned' : '');
        
        let purchaseHTML;
        if(isTraining){
            purchaseHTML = `
                <div class="price-tag">${item.currency === 'gems' ? 'üíé' : 'üí∞'}${item.price}</div>
                <button class="buy-btn" ${canBuy ? `onclick="buyItem('${cat}','${item.id}')"` : 'disabled'}>
                    ${item.repeatable ? 'START' : 'BUY'}
                </button>`;
        } else if(!owned){
            purchaseHTML = `
                <div class="price-tag">${item.currency === 'gems' ? 'üíé' : 'üí∞'}${item.price}</div>
                <button class="buy-btn" ${canBuy ? `onclick="buyItem('${cat}','${item.id}')"` : 'disabled'}>BUY</button>`;
        } else if(equipped){
            purchaseHTML = '<div class="equipped-badge">EQUIPPED</div>';
        } else {
            purchaseHTML = `<button class="equip-btn" onclick="equipItem('${cat}','${item.id}')">EQUIP</button>`;
        }
        
        d.innerHTML = `
            <div class="item-info">
                <div class="item-name">${item.name}</div>
                <div class="item-desc">${item.desc}</div>
                <div class="item-stats">${statsHTML}</div>
            </div>
            <div class="item-purchase">${purchaseHTML}</div>`;
        c.appendChild(d);
    });
}

function buyItem(cat, id){
    const item = SHOP[cat]?.find(i => i.id === id);
    if(!item) return;
    
    const curr = item.currency === 'gems' ? 'gems' : 'coins';
    if(G[curr] < item.price) return;
    
    G[curr] -= item.price;
    
    if(item.repeatable){
        // Training-style items
        if(item.stats.skillPoints){
            const oldNTRP = getNTRP();
            G.skillPoints += item.stats.skillPoints;
            const newNTRP = getNTRP();
            if(newNTRP > oldNTRP){
                toast(`NTRP UPGRADED to ${newNTRP.toFixed(1)}!`);
                sounds.point();
            }
        }
        if(item.stats.power) G.stats.power += item.stats.power;
        if(item.stats.speed) G.stats.speed += item.stats.speed;
        if(item.stats.control) G.stats.control += item.stats.control;
        if(item.stats.serve) G.stats.serve += item.stats.serve;
        G.trainingCompleted.push(id);
        toast(item.name + ' completed!');
    } else {
        // Equipment items
        G.owned.push(id);
        
        // Auto-equip if slot is empty
        let slot = cat.slice(0, -1); // 'rackets' -> 'racket'
        if(cat === 'serve') slot = 'serveGear';
        if(cat === 'special') slot = 'special';
        
        if(!G.equipment[slot]) G.equipment[slot] = id;
        toast(item.name + ' purchased!');
    }
    
    save();
    renderShop(cat);
    updateUI();
}

function equipItem(cat, id){
    let slot = cat.slice(0, -1);
    if(cat === 'serve') slot = 'serveGear';
    G.equipment[slot] = id;
    save();
    renderShop(cat);
    toast('Equipped!');
}

function showTutorial(){
    document.getElementById('tutorialOverlay').classList.add('active');
}

function closeTutorial(){
    document.getElementById('tutorialOverlay').classList.remove('active');
}

function toast(msg){
    const t = document.getElementById('progressToast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

// ========== VIDEO & MATCH START ==========

let ytPlayer;

function onYouTubeIframeAPIReady(){
    ytPlayer = new YT.Player('videoPlayer', {
        height: '100%',
        width: '100%',
        videoId: 'dy1tT2lsISs',
        playerVars: {autoplay:0, controls:0, modestbranding:1, rel:0, showinfo:0, fs:0, playsinline:1},
        events: {onStateChange: onPlayerStateChange}
    });
}

function onPlayerStateChange(event){
    if(event.data === YT.PlayerState.ENDED) transitionToCourt();
}

function transitionToCourt(){
    if(videoTimeout) { clearTimeout(videoTimeout); videoTimeout = null; }
    if(ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
    const videoIntro = document.getElementById('videoIntro');
    videoIntro.classList.add('fade-out');
    setTimeout(() => {
        videoIntro.classList.remove('active', 'fade-out');
        actuallyStartMatch();
    }, 500);
}

function actuallyStartMatch(){
    const s = DIFF[G.difficulty];
    
    // Adjust time based on match type
    let matchTime = s.time;
    if(G.matchType === 'quick') matchTime = 90;  // Shorter for quick match
    else if(G.matchType === 'timed') matchTime = 180; // 3 minutes for timed
    
    // Randomly decide who serves first
    const playerServesFirst = Math.random() < 0.5;
    
    M = {
        active: true,
        pPoints: 0, oPoints: 0,
        pGames: 0, oGames: 0,
        pSets: 0, oSets: 0,
        time: matchTime,
        isTiebreak: false,
        tiebreakServer: 'player',
        servingPlayer: playerServesFirst ? 'player' : 'opp',
        serveNum: 1,
        serveSide: 'deuce',
        isPlayerServe: false,
        servePhase: 'none',
        servePower: 0,
        serveAimX: 50,
        serveAimY: 25,
        serveStartY: null,
        serveStartX: null,
        lastServeSpeed: 0,
        rally: 0,
        ballActive: false,
        ballPos: {x:50, y:10},
        ballVel: {x:0, y:0, z:0},
        ballH: 100,
        ballBounces: 0,
        ballSpin: 0,
        canHit: false,
        combo: 0,
        streak: 0,
        oppPos: 50,
        playerPos: 70,
        gemActive: false,
        gemPos: {x:50, y:70},
        gemTimer: 0,
        gemMultiplier: 1,
        aces: 0,
        doubleFaults: 0,
        winners: 0,
        longestRally: 0,
        totalRallies: 0,
        pointsPlayed: 0,
        pendingAce: false,
        settings: s
    };
    
    initSprites();
    
    document.getElementById('gameHUD').classList.add('active');
    document.getElementById('gameCourt').classList.add('active');
    document.getElementById('playerPaddle').style.left = '70%';
    document.getElementById('streakDisplay').classList.remove('active');
    
    updateMatchUI();
    startTimer();
    
    // Start first point
    setTimeout(startNextPoint, 1200);
}

function startNextPoint(){
    if(!M.active) return;
    
    M.serveNum = 1;
    M.serveSide = getServeSide();
    M.rally = 0;
    M.canHit = false;
    
    // Clear serve speed display
    document.getElementById('serveSpeed').textContent = '';
    
    // In tiebreak, recalculate server each point
    if(M.isTiebreak){
        M.servingPlayer = getTiebreakServer();
    }
    
    updateMatchUI();
    
    if(M.servingPlayer === 'player'){
        startPlayerServe();
    } else {
        opponentServe();
    }
}

let videoTimeout = null;
function startMatch(){
    document.getElementById('mainMenu').classList.remove('active');
    document.getElementById('charSelect').classList.remove('active');
    document.getElementById('shopScreen').classList.remove('active');
    document.getElementById('videoIntro').classList.add('active');
    
    // Auto-skip after 8 seconds if video fails
    if(videoTimeout) clearTimeout(videoTimeout);
    videoTimeout = setTimeout(() => {
        if(document.getElementById('videoIntro').classList.contains('active')) {
            transitionToCourt();
        }
    }, 8000);
    
    if(ytPlayer && ytPlayer.playVideo){
        ytPlayer.seekTo(0);
        ytPlayer.playVideo();
    } else {
        setTimeout(() => {
            if(ytPlayer && ytPlayer.playVideo){
                ytPlayer.seekTo(0);
                ytPlayer.playVideo();
            }
        }, 1000);
    }
}

function startTimer(){
    const int = setInterval(() => {
        if(!M.active){
            clearInterval(int);
            return;
        }
        M.time--;
        document.getElementById('matchTimer').textContent = 
            Math.floor(M.time/60) + ':' + (M.time%60).toString().padStart(2,'0');
        if(M.time <= 0){
            clearInterval(int);
            endMatch();
        }
    }, 1000);
}

// ========== SCORING ==========

function getTennisScore(pPoints, oPoints){
    // Tiebreak uses simple numbers
    if(M.isTiebreak){
        return {p: String(pPoints), o: String(oPoints), tiebreak: true};
    }
    
    const scores = ['0','15','30','40'];
    
    // Both under 4 points - normal scoring
    if(pPoints < 4 && oPoints < 4){
        return {p: scores[pPoints], o: scores[oPoints]};
    }
    
    // Deuce situation
    if(pPoints === oPoints){
        return {p:'40', o:'40', deuce:true};
    }
    
    // Advantage
    if(pPoints > oPoints){
        return {p:'AD', o:'40'};
    }
    return {p:'40', o:'AD'};
}

function updateMatchUI(){
    const score = getTennisScore(M.pPoints, M.oPoints);
    
    document.getElementById('playerPoints').textContent = score.deuce ? 'DEUCE' : score.p;
    document.getElementById('opponentPoints').textContent = score.deuce ? 'DEUCE' : score.o;
    document.getElementById('playerGames').textContent = M.pGames;
    document.getElementById('opponentGames').textContent = M.oGames;
    document.getElementById('rallyCount').textContent = M.rally;
    
    // Show sets if any
    if(M.pSets > 0 || M.oSets > 0){
        document.getElementById('playerSets').textContent = `Sets: ${M.pSets}`;
        document.getElementById('opponentSets').textContent = `Sets: ${M.oSets}`;
    }
    
    // Show tiebreak indicator
    const tbInd = document.getElementById('tiebreakIndicator');
    if(M.isTiebreak){
        tbInd.textContent = 'TIEBREAK';
    } else {
        tbInd.textContent = '';
    }
    
    updateServeIndicator();
}

function scorePoint(player){
    // Track statistics
    M.pointsPlayed++;
    M.totalRallies += M.rally;
    if(M.rally > M.longestRally) M.longestRally = M.rally;
    
    if(player === 'p'){
        M.pPoints++;
    } else {
        M.oPoints++;
        M.streak = 0;
        updateStreakDisplay();
    }
    
    const diff = M.pPoints - M.oPoints;
    
    // Tiebreak scoring: first to 7, win by 2
    if(M.isTiebreak){
        if((M.pPoints >= 7 || M.oPoints >= 7) && Math.abs(diff) >= 2){
            // Tiebreak won!
            if(M.pPoints > M.oPoints){
                M.pGames++;
                M.pSets++;
                toast('TIEBREAK WON! You take the set!');
            } else {
                M.oGames++;
                M.oSets++;
                toast('TIEBREAK LOST! Opponent takes the set');
            }
            
            // Reset for new set
            M.pPoints = 0;
            M.oPoints = 0;
            M.pGames = 0;
            M.oGames = 0;
            M.isTiebreak = false;
            M.serveNum = 1;
            
            // Whoever received in tiebreak serves first next set
            M.servingPlayer = M.tiebreakServer === 'player' ? 'opp' : 'player';
            
            sounds.point();
            updateMatchUI();
            if(checkEnd()) return true;
            return false;
        }
        
        // In tiebreak, server changes after first point, then every 2 points
        M.servingPlayer = getTiebreakServer();
        M.serveNum = 1;
        updateMatchUI();
        return false;
    }
    
    // Regular game scoring: need to be at 4+ and 2 ahead
    if((M.pPoints >= 4 || M.oPoints >= 4) && Math.abs(diff) >= 2){
        if(M.pPoints > M.oPoints){
            M.pGames++;
            toast('GAME! You won the game!');
        } else {
            M.oGames++;
            toast('GAME! Opponent won');
        }
        
        M.pPoints = 0;
        M.oPoints = 0;
        
        // Switch server after each game
        M.servingPlayer = M.servingPlayer === 'player' ? 'opp' : 'player';
        M.serveNum = 1;
        
        sounds.point();
        
        // Check for set/match win
        if(checkSetWin()){
            return true;
        }
        
        // Changeover after odd games
        if(shouldChangeover()){
            setTimeout(async () => {
                await showCourtChange('CHANGEOVER', `${M.pGames}-${M.oGames}`);
                startNextPoint();
            }, 500);
            updateMatchUI();
            return true; // Prevent normal startNextPoint
        }
    }
    
    updateMatchUI();
    
    if(checkEnd()) return true;
    return false;
}

function checkSetWin(){
    const pGames = M.pGames;
    const oGames = M.oGames;
    const diff = Math.abs(pGames - oGames);
    
    // Standard set win: 6 games with 2 game lead
    if((pGames >= 6 || oGames >= 6) && diff >= 2 && !M.isTiebreak){
        if(pGames > oGames){
            M.pSets++;
            toast('SET! You won the set!');
        } else {
            M.oSets++;
            toast('SET! Opponent won the set');
        }
        M.pGames = 0;
        M.oGames = 0;
        M.isTiebreak = false;
        return false; // Continue playing
    }
    
    // Tiebreak at 6-6
    if(pGames === 6 && oGames === 6 && !M.isTiebreak){
        M.isTiebreak = true;
        M.tiebreakServer = M.servingPlayer;
        M.pPoints = 0;
        M.oPoints = 0;
        toast('TIEBREAK! First to 7 (win by 2)');
        sounds.point();
        return false;
    }
    
    return false;
}

// ========== BALL PHYSICS ==========

function animateBall(){
    if(!M.ballActive) return;
    
    M.ballPos.x += M.ballVel.x;
    M.ballPos.y += M.ballVel.y;
    M.ballH += M.ballVel.z;
    M.ballVel.z -= 0.15; // Gravity
    
    // Apply spin (slight curve)
    if(M.ballSpin !== 0){
        M.ballVel.x += M.ballSpin * 0.01;
    }
    
    // Ground bounce
    if(M.ballH <= 0 && M.ballVel.z < 0){
        M.ballH = 0;
        M.ballVel.z = -M.ballVel.z * 0.65; // Dampened bounce
        sounds.bounce();
        
        if(M.ballPos.y > 50) M.ballBounces++;
        
        // Double bounce = point lost
        if(M.ballBounces > 1){
            ballMissed();
            return;
        }
    }
    
    // Out of bounds (sidelines)
    if(M.ballPos.x < 10 || M.ballPos.x > 90){
        ballOut('wide');
        return;
    }
    
    const ball = document.getElementById('ball');
    const shadow = document.getElementById('ballShadow');
    ball.style.left = M.ballPos.x + '%';
    ball.style.top = (M.ballPos.y - M.ballH/12) + '%';
    shadow.style.left = M.ballPos.x + '%';
    shadow.style.top = M.ballPos.y + '%';
    
    // Check if ball is in player's hit zone
    const st = getStats();
    const hzStart = Math.max(52, 100 - M.settings.hitWindow * 100 - st.control * 0.12);
    
    if(M.ballPos.y > hzStart && M.ballPos.y < 90 && M.ballH < 50 && M.ballBounces <= 1 && !M.canHit){
        M.canHit = true;
        ball.classList.add('glowing');
        document.getElementById('hitZone').classList.add('active');
        
        const hint = document.getElementById('swipeHint');
        hint.textContent = 'SWIPE UP!';
        hint.classList.remove('serve');
        hint.classList.add('active');
        
        document.getElementById('playerPaddle').classList.add('can-hit');
    }
    
    // Ball passed hit zone
    if(M.canHit && (M.ballH > 50 || M.ballBounces > 1)){
        M.canHit = false;
        ball.classList.remove('glowing');
        document.getElementById('hitZone').classList.remove('active');
        document.getElementById('swipeHint').classList.remove('active');
        document.getElementById('playerPaddle').classList.remove('can-hit');
    }
    
    // Ball passed player - missed
    if(M.ballPos.y > 93){
        ballMissed();
        return;
    }
    
    // Update opponent position when ball is on their side
    if(M.ballPos.y < 50) updateOpp();
    
    updatePlayerDirection();
    requestAnimationFrame(animateBall);
}

function updateOpp(){
    const diff = M.ballPos.x - M.oppPos;
    const moving = Math.abs(diff) > 2;
    setOppRunning(moving);
    M.oppPos += diff * M.settings.oppSpeed;
    document.getElementById('opponent').style.left = M.oppPos + '%';
}

function ballOut(reason){
    M.ballActive = false;
    M.canHit = false;
    resetBallUI();
    M.combo = 0;
    M.rally = 0;
    sounds.miss();
    showCallOverlay('OUT!', false);
    
    M.streak = 0;
    updateStreakDisplay();
    
    if(!scorePoint('o')) setTimeout(startNextPoint, 1500);
}

function ballMissed(){
    M.ballActive = false;
    M.canHit = false;
    resetBallUI();
    M.combo = 0;
    M.rally = 0;
    sounds.miss();
    
    M.streak = 0;
    updateStreakDisplay();
    
    if(!scorePoint('o')) setTimeout(startNextPoint, 1200);
}

function resetBallUI(){
    const ball = document.getElementById('ball');
    const shadow = document.getElementById('ballShadow');
    ball.classList.remove('active', 'glowing', 'toss');
    shadow.classList.remove('active');
    document.getElementById('hitZone').classList.remove('active');
    document.getElementById('swipeHint').classList.remove('active', 'serve');
    document.getElementById('playerPaddle').classList.remove('can-hit', 'serving');
    document.getElementById('servePower').classList.remove('active');
    document.getElementById('serveAim').classList.remove('active');
    document.getElementById('serveTargetLine').classList.remove('active');
    clearServiceBoxHighlight();
}

// ========== HITTING ==========

function hitBall(power, angle){
    if(!M.canHit) return;
    
    M.canHit = false;
    const ball = document.getElementById('ball');
    ball.classList.remove('glowing');
    document.getElementById('hitZone').classList.remove('active');
    document.getElementById('swipeHint').classList.remove('active');
    document.getElementById('playerPaddle').classList.remove('can-hit');
    
    // Show power feedback
    const pf = document.getElementById('powerFill');
    pf.style.width = (power * 100) + '%';
    setTimeout(() => pf.style.width = '0%', 400);
    
    const st = getStats();
    const dist = Math.abs(M.ballPos.x - M.playerPos);
    const acc = Math.max(0, 1 - dist/50);
    const qual = power * acc * (1 + st.control/100);
    
    showHitEffect(power);
    
    // Player swing animation
    document.getElementById('playerSprite').style.backgroundImage = `url(${SPRITES.playerSwing})`;
    document.getElementById('playerSprite').style.backgroundSize = '640px 96px';
    playSprite('playerSprite', 8);
    
    sounds.hit();
    
    if(qual > 0.55){
        M.combo++;
        showCombo();
    } else {
        M.combo = 0;
    }
    
    returnBall(qual, angle);
}

function showHitEffect(power){
    const e = document.getElementById('hitEffect');
    const b = document.getElementById('ball');
    e.style.left = b.style.left;
    e.style.top = b.style.top;
    e.classList.add('active');
    setTimeout(() => e.classList.remove('active'), 600);
    
    // Screen shake on powerful hits
    if(power > 0.7){
        const court = document.getElementById('gameCourt');
        court.classList.remove('shake');
        void court.offsetWidth;
        court.classList.add('shake');
        setTimeout(() => court.classList.remove('shake'), 150);
    }
}

function showCombo(){
    const texts = ['NICE!', 'GREAT!', 'PERFECT!', 'AMAZING!', 'INCREDIBLE!'];
    const el = document.createElement('div');
    el.className = 'combo-text';
    el.textContent = texts[Math.min(M.combo - 1, 4)];
    el.style.left = '50%';
    el.style.top = '50%';
    el.style.animation = 'comboFloat 0.9s ease-out forwards';
    document.querySelector('.court').appendChild(el);
    setTimeout(() => el.remove(), 900);
}

function returnBall(qual, angle){
    M.ballActive = true;
    M.ballBounces = 0;
    M.rally++;
    
    // Gem spawn chance increases with rally length
    const gemChance = 0.05 + M.rally * 0.02;
    if(Math.random() < gemChance && !M.gemActive) spawnGem();
    
    const st = getStats();
    const spd = 1 + st.power * 0.012;
    const ctrl = 1 + st.control * 0.008;
    const off = M.playerPos - M.ballPos.x;
    const ang = Math.sin(angle) * 1.1 * ctrl;
    const pos = off * 0.018;
    
    // Add spin based on angle
    M.ballSpin = Math.sin(angle) * 0.5;
    
    M.ballH = 30;
    M.ballVel = {
        x: Math.max(-1.3, Math.min(1.3, (ang + pos) * 0.75)),
        y: -1.6 * spd * qual * 0.65,
        z: 2.5 * qual
    };
    
    animateReturn();
}

function animateReturn(){
    if(!M.ballActive) return;
    
    M.ballPos.x += M.ballVel.x;
    M.ballPos.y += M.ballVel.y;
    M.ballH += M.ballVel.z;
    M.ballVel.z -= 0.15;
    
    // Spin effect
    if(M.ballSpin !== 0){
        M.ballVel.x += M.ballSpin * 0.008;
    }
    
    // Ground bounce
    if(M.ballH <= 0 && M.ballVel.z < 0){
        M.ballH = 0;
        M.ballVel.z = -M.ballVel.z * 0.65;
        sounds.bounce();
    }
    
    // Out wide
    if(M.ballPos.x < 10 || M.ballPos.x > 90){
        M.ballActive = false;
        resetBallUI();
        M.combo = 0;
        M.rally = 0;
        M.streak = 0;
        updateStreakDisplay();
        sounds.miss();
        toast('OUT!');
        if(!scorePoint('o')) setTimeout(startNextPoint, 1200);
        return;
    }
    
    const ball = document.getElementById('ball');
    const shadow = document.getElementById('ballShadow');
    ball.style.left = M.ballPos.x + '%';
    ball.style.top = (M.ballPos.y - M.ballH/12) + '%';
    shadow.style.left = M.ballPos.x + '%';
    shadow.style.top = M.ballPos.y + '%';
    
    // Ball reached opponent's side
    if(M.ballPos.y < 12){
        M.ballActive = false;
        
        const st = getStats();
        const dist = Math.abs(M.ballPos.x - M.oppPos);
        const reach = dist < 28;
        const hq = Math.max(0, 1 - dist * 0.025);
        const prob = reach ? (M.settings.oppAcc * hq - st.power * 0.002) : 0;
        
        // Check for net cord as ball crosses net zone (43-57%)
        if(M.ballPos.y > 43 && M.ballPos.y < 57 && Math.random() < 0.08){
            showNetCordEffect();
            sounds.let();
        }
        
        if(Math.random() < prob){
            // Opponent returns
            M.rally++;
            M.ballBounces = 0;
            updateMatchUI();
            
            M.ballPos = {x: M.oppPos, y: 12};
            M.ballH = 60;
            
            const tx = M.playerPos > 50 ? 25 + Math.random() * 25 : 50 + Math.random() * 25;
            M.ballVel = {
                x: (tx - M.ballPos.x) / 100 * 1.8,
                y: M.settings.speed * 0.6,
                z: 1.5
            };
            M.ballSpin = (Math.random() - 0.5) * 0.3;
            
            document.getElementById('opponent').classList.add('hitting');
            setOppSwinging();
            setTimeout(() => document.getElementById('opponent').classList.remove('hitting'), 250);
            sounds.hit();
            
            M.ballActive = true;
            M.canHit = false;
            ball.classList.add('active');
            ball.classList.remove('glowing');
            shadow.classList.add('active');
            
            animateBall();
        } else {
            // Opponent missed - point for player! (Winner!)
            resetBallUI();
            M.rally = 0;
            M.winners++;
            
            let reward = 10 + M.combo * 5;
            if(G.equipment.special === 'x1') reward *= 2;
            G.coins += reward;
            
            M.streak++;
            updateStreakDisplay();
            
            // Show winner call for clean winners
            if(M.combo >= 2 || Math.random() < 0.25){
                showCallOverlay('WINNER!', true);
                sounds.winner();
            } else {
                sounds.coin();
            }
            
            toast('+' + reward + ' üí∞');
            
            if(!scorePoint('p')) setTimeout(startNextPoint, 1500);
        }
        return;
    }
    
    if(M.ballPos.y < 50) updateOpp();
    updatePlayerDirection();
    requestAnimationFrame(animateReturn);
}

function checkEnd(){
    const gameDiff = Math.abs(M.pGames - M.oGames);
    
    // Different win conditions based on match type
    const winGames = G.matchType === 'quick' ? 3 : 6;
    
    if(G.matchType === 'timed'){
        // Timed mode: play until time runs out
        if(M.time <= 0){
            endMatch();
            return true;
        }
    } else {
        // Quick or Standard: win by games
        if((M.pGames >= winGames || M.oGames >= winGames) && gameDiff >= 2){
            endMatch();
            return true;
        }
        // Tiebreak at winGames-winGames
        if(M.pGames === winGames && M.oGames === winGames && !M.isTiebreak){
            M.isTiebreak = true;
            M.tiebreakServer = M.servingPlayer;
            M.pPoints = 0;
            M.oPoints = 0;
            toast('TIEBREAK!');
            sounds.point();
        }
    }
    
    // Time's up (for all modes as backup)
    if(M.time <= 0){
        endMatch();
        return true;
    }
    
    return false;
}

function endMatch(){
    M.active = false;
    
    const won = M.pGames > M.oGames;
    
    let coins = won ? 80 : 25;
    coins = Math.floor(coins * M.settings.mult);
    if(G.equipment.special === 'x1') coins *= 2;
    
    // Bonus for aces
    coins += M.aces * 10;
    
    const skill = Math.floor((won ? 25 : 10) * M.settings.mult);
    
    let gems = 0;
    if(won && Math.random() < 0.2 * M.settings.mult){
        gems = Math.floor(Math.random() * 3) + 1;
    }
    // Bonus gems for streak
    gems += Math.floor(M.streak / 3);
    
    const oldNTRP = getNTRP();
    G.coins += coins;
    G.skillPoints += skill;
    G.gems += gems;
    const newNTRP = getNTRP();
    
    if(newNTRP > oldNTRP){
        setTimeout(() => {
            toast(`NTRP UPGRADED to ${newNTRP.toFixed(1)}!`);
            sounds.point();
        }, 1500);
    }
    
    save();
    
    document.getElementById('gameHUD').classList.remove('active');
    document.getElementById('gameCourt').classList.remove('active');
    document.getElementById('streakDisplay').classList.remove('active');
    
    const rt = document.getElementById('resultsTitle');
    rt.textContent = won ? 'VICTORY' : 'DEFEAT';
    rt.className = 'results-title ' + (won ? 'victory' : 'defeat');
    
    document.getElementById('finalScore').textContent = M.pGames + ' - ' + M.oGames;
    document.getElementById('coinsEarned').textContent = '+' + coins;
    document.getElementById('skillGained').textContent = '+' + skill;
    document.getElementById('gemsEarned').textContent = '+' + gems;
    document.getElementById('acesCount').textContent = M.aces;
    document.getElementById('winnersCount').textContent = M.winners;
    document.getElementById('longestRally').textContent = M.longestRally;
    document.getElementById('avgRally').textContent = M.pointsPlayed > 0 ? 
        (M.totalRallies / M.pointsPlayed).toFixed(1) : '0';
    
    document.getElementById('matchResults').classList.add('active');
    
    if(won) sounds.point();
}

function returnToMenu(){
    document.getElementById('matchResults').classList.remove('active');
    document.getElementById('mainMenu').classList.add('active');
    resetBallUI();
    updateUI();
}

// ========== INPUT HANDLING ==========

let touchY = null, touchX = null, touchT = null;

document.addEventListener('touchstart', e => {
    if(!M.active) return;
    
    const t = e.touches[0];
    touchY = t.clientY;
    touchX = t.clientX;
    touchT = Date.now();
    
    // Handle serve charging
    if(M.isPlayerServe && M.servePhase === 'ready'){
        chargingServe(t.clientY, t.clientX);
        return;
    }
    
    updatePlayerPos(t.clientX);
    setPlayerRunning(true);
});

document.addEventListener('touchmove', e => {
    if(!M.active) return;
    e.preventDefault();
    
    const t = e.touches[0];
    
    // Continue charging serve
    if(M.servePhase === 'charging'){
        chargingServe(t.clientY, t.clientX);
        return;
    }
    
    updatePlayerPos(t.clientX);
}, {passive: false});

document.addEventListener('touchend', e => {
    setPlayerRunning(false);
    
    if(!M.active) return;
    
    const t = e.changedTouches[0];
    
    // Release serve
    if(M.servePhase === 'charging'){
        releaseServe(t.clientX, t.clientY);
        touchY = touchX = null;
        return;
    }
    
    // Normal hit
    if(!M.canHit || !touchY) return;
    
    const dy = touchY - t.clientY;
    const dx = t.clientX - touchX;
    const dt = Date.now() - touchT;
    
    if(dy > 8 || (dt < 180 && Math.abs(dy) < 8)){
        const pwr = Math.min(1, Math.max(0.3, dy/90));
        const ang = Math.atan2(dx, Math.max(1, dy));
        hitBall(pwr, ang);
    }
    
    touchY = touchX = null;
});

// Mouse support
document.addEventListener('mousedown', e => {
    if(!M.active) return;
    
    touchY = e.clientY;
    touchX = e.clientX;
    touchT = Date.now();
    
    if(M.isPlayerServe && M.servePhase === 'ready'){
        chargingServe(e.clientY, e.clientX);
        return;
    }
    
    updatePlayerPos(e.clientX);
    setPlayerRunning(true);
});

document.addEventListener('mousemove', e => {
    if(!M.active) return;
    
    if(M.servePhase === 'charging'){
        chargingServe(e.clientY, e.clientX);
        return;
    }
    
    updatePlayerPos(e.clientX);
});

document.addEventListener('mouseup', e => {
    setPlayerRunning(false);
    
    if(!M.active) return;
    
    if(M.servePhase === 'charging'){
        releaseServe(e.clientX, e.clientY);
        touchY = touchX = null;
        return;
    }
    
    if(!M.canHit || !touchY) return;
    
    const dy = touchY - e.clientY;
    const dx = e.clientX - touchX;
    
    if(dy > 8 || Date.now() - touchT < 180){
        const pwr = Math.min(1, Math.max(0.3, dy/90));
        const ang = Math.atan2(dx, Math.max(1, dy));
        hitBall(pwr, ang);
    }
    
    touchY = touchX = null;
});

function updatePlayerPos(x){
    if(M.isPlayerServe) return; // Don't move during serve
    
    const court = document.querySelector('.court');
    if(!court) return;
    
    const r = court.getBoundingClientRect();
    const rel = ((x - r.left) / r.width) * 100;
    M.playerPos = Math.max(12, Math.min(88, rel));
    document.getElementById('playerPaddle').style.left = M.playerPos + '%';
    updatePlayerDirection();
}

function updatePlayerDirection(){
    if(!M.ballActive) return;
    
    const playerSprite = document.querySelector('.player-sprite-active');
    if(!playerSprite) return;
    
    if(M.ballPos.x < M.playerPos){
        playerSprite.classList.add('flipped');
    } else {
        playerSprite.classList.remove('flipped');
    }
}

// Gem collection
document.getElementById('gemDrop').addEventListener('click', collectGem);
document.getElementById('gemDrop').addEventListener('touchstart', e => {
    e.stopPropagation();
    collectGem();
});

window.addEventListener('load', () => {
    document.body.addEventListener('touchmove', e => e.preventDefault(), {passive: false});
    initSprites();
});

// ========== SPRITE ANIMATION FUNCTIONS ==========

function initSprites(){
    const opp = document.getElementById('opponentSprite');
    const player = document.getElementById('playerSprite');
    
    opp.style.backgroundImage = `url(${SPRITES.oppIdle})`;
    opp.style.backgroundSize = '80px 96px';
    player.style.backgroundImage = `url(${SPRITES.playerIdle})`;
    player.style.backgroundSize = '80px 96px';
    
    // Preload sprites
    [SPRITES.playerRun, SPRITES.playerSwing, SPRITES.oppRun, SPRITES.oppSwing].forEach(s => {
        new Image().src = s;
    });
}

function playSprite(spriteId, frames){
    const sprite = document.getElementById(spriteId);
    sprite.classList.remove('playing-4', 'playing-5', 'playing-7', 'playing-8');
    void sprite.offsetWidth; // Force reflow
    sprite.classList.add(frames === 8 ? 'playing-8' : frames === 7 ? 'playing-7' : frames === 4 ? 'playing-4' : 'playing-5');
}

function setPlayerRunning(running){
    const sprite = document.getElementById('playerSprite');
    if(running){
        sprite.style.backgroundImage = `url(${SPRITES.playerRun})`;
        sprite.style.backgroundSize = '640px 96px';
        sprite.classList.add('cycling');
    } else {
        sprite.classList.remove('cycling');
        sprite.style.backgroundImage = `url(${SPRITES.playerIdle})`;
        sprite.style.backgroundSize = '80px 96px';
        sprite.style.backgroundPosition = '0 0';
    }
}

let oppRunning = false, oppStopTimer = null;

function setOppRunning(running){
    if(running){
        if(oppStopTimer){
            clearTimeout(oppStopTimer);
            oppStopTimer = null;
        }
        if(oppRunning) return;
        oppRunning = true;
        const opp = document.getElementById('opponentSprite');
        opp.style.backgroundImage = `url(${SPRITES.oppRun})`;
        opp.style.backgroundSize = '640px 96px';
        opp.classList.add('cycling');
    } else {
        if(!oppRunning || oppStopTimer) return;
        oppStopTimer = setTimeout(() => {
            oppRunning = false;
            oppStopTimer = null;
            const opp = document.getElementById('opponentSprite');
            opp.classList.remove('cycling');
            opp.style.backgroundImage = `url(${SPRITES.oppIdle})`;
            opp.style.backgroundSize = '80px 96px';
            opp.style.backgroundPosition = '0 0';
        }, 150);
    }
}

function setOppSwinging(){
    oppRunning = false;
    const opp = document.getElementById('opponentSprite');
    opp.classList.remove('cycling');
    opp.style.backgroundImage = `url(${SPRITES.oppSwing})`;
    opp.style.backgroundSize = '640px 96px';
    playSprite('opponentSprite', 8);
    setTimeout(() => {
        opp.style.backgroundImage = `url(${SPRITES.oppIdle})`;
        opp.style.backgroundSize = '80px 96px';
    }, 500);
}
</script>
</body>
</html>
<!-- v7 Refinement: Serving, Tennis Rules, Gems, Polish - Sat Feb 7 2026 -->